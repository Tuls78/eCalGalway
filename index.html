<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AFM Galway Assembly ‚Äì 2026 E-Calendar</title>
    <style>
        /* ============ RESET & BASE ============ */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.5;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ============ HEADER ============ */
        .header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #fff;
            padding: 18px 16px 14px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.25);
        }

        @media print {

            .nav,
            .view-tabs,
            .filters,
            .admin-toggle,
            .share-bar,
            .admin-panel,
            .panel-overlay,
            .panel-buttons,
            .btn-whatsapp {
                display: none !important;
            }

            .header,
            .nav {
                position: static !important;
            }

            body,
            .cal-container {
                background: white !important;
                padding: 0 !important;
            }

            .cal-grid {
                gap: 1px;
                background: #999;
            }

            .cal-cell {
                background: white;
                border: none;
            }

            .legend {
                display: flex !important;
            }

            /* Force single page per month if possible */
            .cal-container {
                page-break-inside: avoid;
            }
        }

        .header h1 {
            font-size: 1.25rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            color: #e94560;
        }

        .header .subtitle {
            font-size: 0.75rem;
            opacity: 0.85;
            margin-top: 2px;
        }

        .header .venue {
            font-size: 0.65rem;
            opacity: 0.6;
            margin-top: 2px;
        }

        .header .service-time {
            display: inline-block;
            margin-top: 6px;
            padding: 3px 14px;
            background: #e94560;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        /* ============ NAVIGATION ============ */
        .nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 16px;
            background: #fff;
            border-bottom: 1px solid #e0e0e0;
            position: sticky;
            top: 96px;
            z-index: 99;
        }

        .nav button {
            background: none;
            border: 2px solid #e94560;
            color: #e94560;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .nav button:hover {
            background: #e94560;
            color: #fff;
        }

        .nav .month-year {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1a1a2e;
        }

        /* ============ DEPARTMENT FILTERS ============ */
        .filters {
            display: flex;
            gap: 6px;
            padding: 10px 16px;
            overflow-x: auto;
            background: #fff;
            border-bottom: 1px solid #eee;
            -webkit-overflow-scrolling: touch;
        }

        .filters::-webkit-scrollbar {
            display: none;
        }

        .filter-btn {
            white-space: nowrap;
            padding: 5px 12px;
            border-radius: 20px;
            border: 1.5px solid #ddd;
            background: #fff;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .filter-btn.active {
            color: #fff;
            border-color: transparent;
        }

        .filter-btn[data-dept="all"].active {
            background: #1a1a2e;
        }

        .filter-btn[data-dept="general"].active {
            background: #e94560;
        }

        .filter-btn[data-dept="ladies"].active {
            background: #E91E63;
        }

        .filter-btn[data-dept="men"].active {
            background: #1565C0;
        }

        .filter-btn[data-dept="youth"].active {
            background: #FF9800;
        }

        .filter-btn[data-dept="sunday-school"].active {
            background: #4CAF50;
        }

        .filter-btn[data-dept="national"].active {
            background: #7B1FA2;
        }

        /* ============ CALENDAR GRID ============ */
        .cal-container {
            padding: 10px 12px 80px;
            position: relative;
            overflow: hidden;
        }

        .watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0.04;
            pointer-events: none;
            z-index: 0;
            width: 320px;
            height: 320px;
        }

        .cal-grid,
        .day-headers,
        .legend,
        .event-list-section {
            position: relative;
            z-index: 1;
        }

        .day-headers {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            font-size: 0.9rem;
            font-weight: 800;
            color: #1a1a2e;
            padding: 10px 0;
            border-bottom: 2px solid #ddd;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .day-headers span:last-child {
            color: #c62828;
            font-weight: 900;
        }

        .cal-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
            margin-top: 4px;
        }

        .cal-cell {
            min-height: 52px;
            padding: 3px;
            border-radius: 8px;
            background: #fff;
            position: relative;
            cursor: pointer;
            transition: all 0.15s;
            border: 1px solid #f0f0f0;
        }

        .cal-cell:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        .cal-cell.empty {
            background: transparent;
            cursor: default;
            border: none;
        }

        .cal-cell.empty:hover {
            box-shadow: none;
            transform: none;
        }

        .cal-cell .day-num {
            font-size: 0.75rem;
            font-weight: 500;
            color: #888;
            display: block;
            text-align: right;
            padding-right: 2px;
        }

        .cal-cell.today {
            border: 2px solid #e94560;
            background: #fff5f7;
        }

        .cal-cell.today .day-num {
            color: #e94560;
            font-weight: 600;
        }

        .cal-cell.past {
            opacity: 0.55;
        }

        .cal-cell.sunday {
            background: #fef5e8;
        }

        .cal-cell.sunday .day-num {
            color: #c62828;
            font-weight: 600;
        }

        .event-dots {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            margin-top: 2px;
        }

        .event-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
        }

        .dot-general {
            background: #e94560;
        }

        .dot-ladies {
            background: #E91E63;
        }

        .dot-men {
            background: #1565C0;
        }

        .dot-youth {
            background: #FF9800;
        }

        .dot-sunday-school {
            background: #4CAF50;
        }

        .dot-national {
            background: #7B1FA2;
        }

        .dot-prayer {
            background: #78909C;
        }

        /* ============ EVENT LIST (below calendar) ============ */
        .month-events {
            margin-top: 16px;
            background: #fff;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
        }

        .month-events h3 {
            font-size: 0.9rem;
            color: #1a1a2e;
            margin-bottom: 10px;
            border-bottom: 2px solid #e94560;
            padding-bottom: 6px;
        }

        .event-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #f5f5f5;
            cursor: pointer;
            transition: background 0.15s;
        }

        .event-item:hover {
            background: #fafafa;
        }

        .event-item:last-child {
            border-bottom: none;
        }

        .event-date-badge {
            min-width: 42px;
            text-align: center;
            padding: 4px 6px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.8rem;
            color: #fff;
        }

        .event-date-badge.bg-general {
            background: #e94560;
        }

        .event-date-badge.bg-ladies {
            background: #E91E63;
        }

        .event-date-badge.bg-men {
            background: #1565C0;
        }

        .event-date-badge.bg-youth {
            background: #FF9800;
        }

        .event-date-badge.bg-sunday-school {
            background: #4CAF50;
        }

        .event-date-badge.bg-national {
            background: #7B1FA2;
        }

        .event-date-badge.bg-prayer {
            background: #78909C;
        }

        .event-info {
            flex: 1;
        }

        .event-info .event-title {
            font-size: 0.82rem;
            font-weight: 600;
            color: #333;
        }

        .event-info .event-dept {
            font-size: 0.65rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .event-info .event-service {
            font-size: 0.7rem;
            color: #555;
            margin-top: 2px;
        }

        .info-icon {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #eee;
            color: #888;
            font-size: 0.65rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            margin-top: 3px;
        }

        .info-icon:hover {
            background: #e94560;
            color: #fff;
        }

        /* ============ MODAL / POPUP ============ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 200;
            align-items: flex-end;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: #fff;
            border-radius: 16px 16px 0 0;
            width: 100%;
            max-width: 480px;
            max-height: 85vh;
            overflow-y: auto;
            padding: 20px 16px 30px;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        .modal-handle {
            width: 40px;
            height: 4px;
            background: #ddd;
            border-radius: 2px;
            margin: 0 auto 16px;
        }

        .modal h2 {
            font-size: 1.1rem;
            color: #1a1a2e;
            margin-bottom: 4px;
        }

        .modal .modal-date {
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 14px;
        }

        .modal .section-label {
            font-size: 0.7rem;
            font-weight: 700;
            color: #e94560;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 14px 0 6px;
        }

        .modal .detail-card {
            background: #f8f8f8;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
        }

        .modal .detail-card .label {
            font-size: 0.7rem;
            color: #888;
        }

        .modal .detail-card .value {
            font-size: 0.9rem;
            font-weight: 600;
            color: #333;
        }

        .modal .status-badge {
            display: inline-block;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 0.65rem;
            font-weight: 600;
            margin-left: 6px;
        }

        .status-pending {
            background: #FFF3E0;
            color: #E65100;
        }

        .status-confirmed {
            background: #E8F5E9;
            color: #2E7D32;
        }

        .status-declined {
            background: #FFEBEE;
            color: #C62828;
        }

        .status-locked {
            background: #E8F5E9;
            color: #1B5E20;
            border: 1px solid #4CAF50;
        }

        .modal .description-box {
            background: #FFF8E1;
            border-left: 3px solid #FF9800;
            padding: 10px 12px;
            border-radius: 0 8px 8px 0;
            font-size: 0.8rem;
            color: #555;
            margin: 8px 0;
        }

        .modal .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin: 4px 4px 4px 0;
        }

        .btn-confirm {
            background: #4CAF50;
            color: #fff;
        }

        .btn-confirm:hover {
            background: #388E3C;
        }

        .btn-reschedule {
            background: #FF9800;
            color: #fff;
        }

        .btn-reschedule:hover {
            background: #F57C00;
        }

        .btn-decline {
            background: #f44336;
            color: #fff;
        }

        .btn-decline:hover {
            background: #D32F2F;
        }

        .btn-whatsapp {
            background: #25D366;
            color: #fff;
        }

        .btn-whatsapp:hover {
            background: #1DA851;
        }

        .btn-close {
            background: #eee;
            color: #333;
        }

        .btn-close:hover {
            background: #ddd;
        }

        .btn-edit {
            background: #1a1a2e;
            color: #fff;
        }

        .btn-edit:hover {
            background: #333;
        }

        /* ============ ADMIN PANEL ============ */
        .admin-toggle {
            position: fixed;
            bottom: 16px;
            right: 16px;
            z-index: 150;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #1a1a2e;
            color: #fff;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .admin-panel {
            display: none;
            position: fixed;
            bottom: 76px;
            right: 16px;
            background: #fff;
            border-radius: 12px;
            padding: 16px;
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 150;
        }

        .admin-panel.active {
            display: block;
        }

        .admin-panel h3 {
            font-size: 0.9rem;
            color: #1a1a2e;
            margin-bottom: 10px;
        }

        .admin-panel select,
        .admin-panel input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.8rem;
            margin-bottom: 8px;
        }

        /* ============ WHATSAPP SHARE BAR ============ */
        .share-bar {
            position: fixed;
            bottom: 16px;
            left: 16px;
            z-index: 150;
        }

        .share-bar button {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #25D366;
            color: #fff;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ============ LEGEND ============ */
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 10px 16px;
            background: #fff;
            border-top: 1px solid #eee;
            margin-top: 8px;
            border-radius: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.65rem;
            color: #666;
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        /* ============ TOAST NOTIFICATION ============ */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: #fff;
            padding: 10px 24px;
            border-radius: 8px;
            font-size: 0.8rem;
            z-index: 300;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .toast.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        /* ============ MONTHLY THEME / VERSE ============ */
        .month-verse {
            text-align: center;
            padding: 12px 20px;
            margin: 0;
            background: linear-gradient(135deg, #fdf6ec 0%, #fef9f0 100%);
            border-bottom: 1px solid #eed;
            position: relative;
            overflow: hidden;
        }

        .month-verse .theme-label {
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #e94560;
            margin-bottom: 2px;
        }

        .month-verse .verse-text {
            font-family: 'Georgia', 'Palatino', 'Book Antiqua', serif;
            font-style: italic;
            font-size: 0.85rem;
            color: #5a3e2b;
            line-height: 1.4;
            max-width: 420px;
            margin: 0 auto;
        }

        .month-verse .verse-ref {
            font-family: 'Segoe UI', sans-serif;
            font-style: normal;
            font-size: 0.65rem;
            color: #999;
            margin-top: 3px;
            font-weight: 600;
        }

        /* ============ PROJECTS OF THE YEAR BAR ============ */
        .projects-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            padding: 8px 16px;
            background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%);
            border-bottom: 1px solid #c8e6c9;
            font-size: 0.75rem;
        }

        .projects-label {
            font-weight: 700;
            color: #2e7d32;
            letter-spacing: 0.5px;
        }

        .project-tag {
            background: #fff;
            border: 1px solid #81c784;
            color: #1b5e20;
            padding: 3px 10px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.7rem;
            white-space: nowrap;
        }

        /* ============ VIEW MODE TABS ============ */
        .view-tabs {
            display: flex;
            justify-content: center;
            gap: 4px;
            padding: 8px 16px;
            background: #fff;
            border-bottom: 1px solid #eee;
        }

        .view-tab {
            padding: 5px 14px;
            border-radius: 20px;
            border: 1.5px solid #ddd;
            background: #fff;
            font-size: 0.7rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            color: #666;
        }

        .view-tab.active {
            background: #1a1a2e;
            color: #fff;
            border-color: #1a1a2e;
        }

        .view-tab:hover {
            border-color: #e94560;
        }

        /* ============ MULTI-MONTH VIEW ============ */
        .multi-month-grid {
            display: grid;
            gap: 16px;
            padding: 16px;
        }

        .multi-month-grid.quarter {
            grid-template-columns: 1fr;
        }

        .multi-month-grid.half {
            grid-template-columns: 1fr;
        }

        .multi-month-grid.full {
            grid-template-columns: 1fr;
        }

        @media (min-width: 700px) {
            .multi-month-grid.quarter {
                grid-template-columns: repeat(3, 1fr);
            }

            .multi-month-grid.half {
                grid-template-columns: repeat(3, 1fr);
            }

            .multi-month-grid.full {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .mini-month {
            background: #fff;
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
            cursor: pointer;
            transition: all 0.2s;
        }

        .mini-month:hover {
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.12);
        }

        .mini-month h4 {
            font-size: 0.85rem;
            color: #1a1a2e;
            margin-bottom: 6px;
            text-align: center;
            border-bottom: 2px solid #e94560;
            padding-bottom: 4px;
        }

        .mini-cal-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            font-size: 0.6rem;
            text-align: center;
        }

        .mini-cal-grid .mini-hdr {
            font-weight: 700;
            color: #999;
            font-size: 0.55rem;
        }

        .mini-cal-grid .mini-day {
            padding: 2px 0;
            border-radius: 3px;
            font-weight: 600;
            color: #444;
        }

        .mini-cal-grid .mini-day.mini-sunday {
            color: #c62828;
            font-weight: 700;
        }

        .mini-cal-grid .mini-day.mini-today {
            background: #e94560;
            color: #fff;
            border-radius: 50%;
        }

        .mini-cal-grid .mini-day.mini-has-event {
            background: #fef0f0;
        }

        .mini-cal-grid .mini-empty {}

        .mini-month .mini-events {
            margin-top: 6px;
            border-top: 1px solid #f0f0f0;
            padding-top: 4px;
            max-height: 80px;
            overflow-y: auto;
        }

        .mini-month .mini-ev {
            font-size: 0.6rem;
            color: #555;
            padding: 1px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ============ RESPONSIVE ============ */
        @media (min-width: 600px) {
            .cal-container {
                max-width: 520px;
                margin: 0 auto;
            }

            .modal {
                border-radius: 16px;
                margin: auto;
            }

            .modal-overlay {
                align-items: center;
            }

            .cal-cell {
                min-height: 72px;
                padding: 5px;
            }

            .cal-cell .day-num {
                font-size: 1rem;
            }
        }

        /* ============ CONFIRMATION WORKFLOW ============ */
        .confirm-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #eee;
        }

        .reschedule-count {
            font-size: 0.7rem;
            color: #888;
            margin-top: 4px;
        }

        .alternative-list {
            margin-top: 8px;
        }

        .alt-member {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 10px;
            background: #f8f8f8;
            border-radius: 6px;
            margin-bottom: 4px;
            font-size: 0.8rem;
        }

        .alt-member button {
            padding: 3px 10px;
            border-radius: 4px;
            border: none;
            background: #e94560;
            color: #fff;
            font-size: 0.7rem;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <!-- ============ HEADER ============ -->
    <div class="header">
        <div style="display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:4px;">
            <!-- AFM Ireland Logo (SVG) -->
            <svg width="56" height="56" viewBox="0 0 300 300" style="flex-shrink:0;" id="afmLogoHeader">
                <defs>
                    <radialGradient id="bgGrad" cx="45%" cy="40%">
                        <stop offset="0%" stop-color="#3068c8"></stop>
                        <stop offset="100%" stop-color="#1a4590"></stop>
                    </radialGradient>
                    <linearGradient id="crownGrad" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="0%" stop-color="#dbbe44"></stop>
                        <stop offset="100%" stop-color="#a88620"></stop>
                    </linearGradient>
                    <linearGradient id="silverRing" x1="0" y1="0" x2="1" y2="1">
                        <stop offset="0%" stop-color="#e8e8ee"></stop>
                        <stop offset="50%" stop-color="#c0c0cc"></stop>
                        <stop offset="100%" stop-color="#e0e0e8"></stop>
                    </linearGradient>
                </defs>
                <!-- Outer thin blue ring -->
                <circle cx="150" cy="150" r="147" fill="none" stroke="#1a4590" stroke-width="3"></circle>
                <!-- Thick silver/gray ring -->
                <circle cx="150" cy="150" r="138" fill="none" stroke="url(#silverRing)" stroke-width="18"></circle>
                <!-- Inner thin blue ring -->
                <circle cx="150" cy="150" r="126" fill="none" stroke="#1a4590" stroke-width="2.5"></circle>
                <!-- Inner blue circle -->
                <circle cx="150" cy="150" r="122" fill="url(#bgGrad)"></circle>

                <!-- Rays: 11 Long, 10 Short -->
                <g transform="translate(142,155)">
                    <!-- Long Rays -->
                    <polygon points="0,-10 -5,-100 0,-115 5,-100" fill="#c8a82a"></polygon>
                    <polygon points="0,-10 -5,-100 0,-115 5,-100" fill="#c8a82a" transform="rotate(20)"></polygon>
                    <polygon points="0,-10 -5,-100 0,-115 5,-100" fill="#c8a82a" transform="rotate(40)"></polygon>
                    <polygon points="0,-10 -5,-100 0,-115 5,-100" fill="#c8a82a" transform="rotate(60)"></polygon>
                    <polygon points="0,-10 -5,-100 0,-115 5,-100" fill="#c8a82a" transform="rotate(80)"></polygon>
                    <polygon points="0,-10 -5,-100 0,-115 5,-100" fill="#c8a82a" transform="rotate(100)"></polygon>
                    <polygon points="0,-10 -5,-100 0,-115 5,-100" fill="#c8a82a" transform="rotate(-20)"></polygon>
                    <polygon points="0,-10 -5,-100 0,-115 5,-100" fill="#c8a82a" transform="rotate(-40)"></polygon>
                    <polygon points="0,-10 -5,-100 0,-115 5,-100" fill="#c8a82a" transform="rotate(-60)"></polygon>
                    <polygon points="0,-10 -5,-100 0,-115 5,-100" fill="#c8a82a" transform="rotate(-80)"></polygon>
                    <polygon points="0,-10 -5,-100 0,-115 5,-100" fill="#c8a82a" transform="rotate(-100)"></polygon>
                    <!-- Short Rays -->
                    <polygon points="0,-10 -3,-85 0,-95 3,-85" fill="#b89828" transform="rotate(10)"></polygon>
                    <polygon points="0,-10 -3,-85 0,-95 3,-85" fill="#b89828" transform="rotate(30)"></polygon>
                    <polygon points="0,-10 -3,-85 0,-95 3,-85" fill="#b89828" transform="rotate(50)"></polygon>
                    <polygon points="0,-10 -3,-85 0,-95 3,-85" fill="#b89828" transform="rotate(70)"></polygon>
                    <polygon points="0,-10 -3,-85 0,-95 3,-85" fill="#b89828" transform="rotate(90)"></polygon>
                    <polygon points="0,-10 -3,-85 0,-95 3,-85" fill="#b89828" transform="rotate(-10)"></polygon>
                    <polygon points="0,-10 -3,-85 0,-95 3,-85" fill="#b89828" transform="rotate(-30)"></polygon>
                    <polygon points="0,-10 -3,-85 0,-95 3,-85" fill="#b89828" transform="rotate(-50)"></polygon>
                    <polygon points="0,-10 -3,-85 0,-95 3,-85" fill="#b89828" transform="rotate(-70)"></polygon>
                    <polygon points="0,-10 -3,-85 0,-95 3,-85" fill="#b89828" transform="rotate(-90)"></polygon>
                </g>

                <!-- Dark blue orb behind crown -->
                <circle cx="138" cy="138" r="16" fill="#0e2660" stroke="#c8a82a" stroke-width="2.5"></circle>

                <!-- Tilted red cross (Behnd Crown) -->
                <g transform="translate(165,130) rotate(28)">
                    <!-- White border -->
                    <rect x="-10" y="-90" width="20" height="180" rx="3" fill="#fff"></rect>
                    <rect x="-45" y="-38" width="90" height="20" rx="3" fill="#fff"></rect>
                    <!-- Red cross -->
                    <rect x="-7" y="-87" width="14" height="174" rx="2" fill="#cc1111"></rect>
                    <rect x="-42" y="-35" width="84" height="14" rx="2" fill="#cc1111"></rect>
                </g>

                <!-- Crown body -->
                <g transform="translate(148,168)">
                    <!-- Crown shape -->
                    <polygon points="-62,12 -54,-14 -38,4 -22,-22 -8,0 8,-22 22,4 38,-14 62,12" fill="url(#crownGrad)" stroke="#8a6e18" stroke-width="1.5"></polygon>
                    <!-- Crown band/rim -->
                    <ellipse cx="0" cy="14" rx="62" ry="10" fill="url(#crownGrad)" stroke="#8a6e18" stroke-width="1.2"></ellipse>
                    <!-- Red jewels -->
                    <rect x="-5" y="6" width="10" height="10" rx="2" fill="#cc1111" stroke="#900" stroke-width="1" transform="rotate(45,0,11)"></rect>
                    <rect x="-30" y="7" width="8" height="8" rx="1.5" fill="#cc1111" stroke="#900" stroke-width="0.8" transform="rotate(45,-26,11)"></rect>
                    <rect x="22" y="7" width="8" height="8" rx="1.5" fill="#cc1111" stroke="#900" stroke-width="0.8" transform="rotate(45,26,11)"></rect>
                    <!-- White cushion at bottom -->
                    <ellipse cx="0" cy="24" rx="55" ry="8" fill="#eef" stroke="#ccc" stroke-width="1"></ellipse>
                    <ellipse cx="0" cy="23" rx="52" ry="6" fill="#fff" opacity="0.6"></ellipse>
                </g>

                <!-- Gold orbs on crown tips -->
                <circle cx="86" cy="154" r="7" fill="#e0d8b0" stroke="#c8a82a" stroke-width="2"></circle>
                <circle cx="210" cy="154" r="7" fill="#e0d8b0" stroke="#c8a82a" stroke-width="2"></circle>
                <circle cx="110" cy="172" r="6" fill="#e0d8b0" stroke="#c8a82a" stroke-width="1.5"></circle>
                <circle cx="186" cy="172" r="6" fill="#e0d8b0" stroke="#c8a82a" stroke-width="1.5"></circle>
            </svg>
            <div>
                <h1>AFM IRELAND</h1>
                <div style="font-size:0.75rem;font-weight:600;letter-spacing:1px;opacity:0.9;">GALWAY ASSEMBLY</div>
            </div>
        </div>
        <div class="subtitle" id="yearSubtitle">2026 Church E-Calendar</div>
        <div class="venue">Galway Westside Community Hall ¬∑ H91 R853</div>
        <span class="service-time">Every Sunday ¬∑ 10:00 Hours</span>
    </div>

    <!-- ============ MONTH NAV ============ -->
    <div class="nav">
        <button onclick="changeMonth(-1)">‚óÄ</button>
        <span class="month-year" id="monthYear">February 2026</span>
        <button onclick="changeMonth(1)">‚ñ∂</button>
    </div>

    <!-- ============ VIEW MODE TABS ============ -->
    <div class="view-tabs">
        <button class="view-tab active" data-view="month" onclick="setView('month')">Monthly</button>
        <button class="view-tab" data-view="quarter" onclick="setView('quarter')">Quarterly</button>
        <button class="view-tab" data-view="half" onclick="setView('half')">Half Year</button>
        <button class="view-tab" data-view="full" onclick="setView('full')">Full Year</button>
    </div>

    <!-- ============ MONTHLY THEME & VERSE ============ -->
    <div class="month-verse" id="monthVerse">
        <div class="theme-label">Love &amp; Unity</div>
        <div class="verse-text">"Above all, clothe yourselves with love, which binds us all together in perfect harmony."</div>
        <div class="verse-ref">‚Äî Colossians 3:14</div>
    </div>

    <!-- ============ PROJECTS OF THE YEAR ============ -->
    <div class="projects-bar" id="projectsBar">
        <span class="projects-label">üìã Projects of the Year:</span>
        <span class="project-tag">üé§ Mikes (Microphones)</span>
        <span class="project-tag">üìΩÔ∏è Projector</span>
    </div>

    <!-- ============ DEPARTMENT FILTERS ============ -->
    <div class="filters">
        <button class="filter-btn active" data-dept="all" onclick="setFilter('all')">All</button>
        <button class="filter-btn" data-dept="general" onclick="setFilter('general')">General</button>
        <button class="filter-btn" data-dept="ladies" onclick="setFilter('ladies')">Ladies</button>
        <button class="filter-btn" data-dept="men" onclick="setFilter('men')">Men</button>
        <button class="filter-btn" data-dept="youth" onclick="setFilter('youth')">Youth</button>
        <button class="filter-btn" data-dept="sunday-school" onclick="setFilter('sunday-school')">Sunday School</button>
        <button class="filter-btn" data-dept="national" onclick="setFilter('national')">National</button>
    </div>

    <!-- ============ MULTI-MONTH VIEW (quarter/half/full) ============ -->
    <div id="multiMonthContainer" style="display:none;"></div>

    <!-- ============ CALENDAR BODY (single month) ============ -->
    <div class="cal-container" id="singleMonthContainer">
        <!-- Watermark logo -->
        <svg class="watermark" viewBox="0 0 300 300">
            <defs>
                <radialGradient id="wmBg" cx="45%" cy="40%">
                    <stop offset="0%" stop-color="#3068c8"></stop>
                    <stop offset="100%" stop-color="#1a4590"></stop>
                </radialGradient>
                <linearGradient id="wmCrown" x1="0" y1="0" x2="0" y2="1">
                    <stop offset="0%" stop-color="#dbbe44"></stop>
                    <stop offset="100%" stop-color="#a88620"></stop>
                </linearGradient>
                <linearGradient id="wmSilver" x1="0" y1="0" x2="1" y2="1">
                    <stop offset="0%" stop-color="#e8e8ee"></stop>
                    <stop offset="50%" stop-color="#c0c0cc"></stop>
                    <stop offset="100%" stop-color="#e0e0e8"></stop>
                </linearGradient>
            </defs>
            <circle cx="150" cy="150" r="147" fill="none" stroke="#1a4590" stroke-width="3"></circle>
            <circle cx="150" cy="150" r="138" fill="none" stroke="url(#wmSilver)" stroke-width="18"></circle>
            <circle cx="150" cy="150" r="126" fill="none" stroke="#1a4590" stroke-width="2.5"></circle>
            <circle cx="150" cy="150" r="122" fill="url(#wmBg)"></circle>

            <!-- Rays: 11 Long, 10 Short -->
            <g transform="translate(142,155)">
                <!-- Long Rays -->
                <polygon points="0,-10 -5,-100 0,-115 5,-100" fill="#c8a82a"></polygon>
                <polygon points="0,-10 -5,-100 0,-115 5,-100" fill="#c8a82a" transform="rotate(20)"></polygon>
                <polygon points="0,-10 -5,-100 0,-115 5,-100" fill="#c8a82a" transform="rotate(40)"></polygon>
                <polygon points="0,-10 -5,-100 0,-115 5,-100" fill="#c8a82a" transform="rotate(60)"></polygon>
                <polygon points="0,-10 -5,-100 0,-115 5,-100" fill="#c8a82a" transform="rotate(80)"></polygon>
                <polygon points="0,-10 -5,-100 0,-115 5,-100" fill="#c8a82a" transform="rotate(100)"></polygon>
                <polygon points="0,-10 -5,-100 0,-115 5,-100" fill="#c8a82a" transform="rotate(-20)"></polygon>
                <polygon points="0,-10 -5,-100 0,-115 5,-100" fill="#c8a82a" transform="rotate(-40)"></polygon>
                <polygon points="0,-10 -5,-100 0,-115 5,-100" fill="#c8a82a" transform="rotate(-60)"></polygon>
                <polygon points="0,-10 -5,-100 0,-115 5,-100" fill="#c8a82a" transform="rotate(-80)"></polygon>
                <polygon points="0,-10 -5,-100 0,-115 5,-100" fill="#c8a82a" transform="rotate(-100)"></polygon>
                <!-- Short Rays -->
                <polygon points="0,-10 -3,-85 0,-95 3,-85" fill="#b89828" transform="rotate(10)"></polygon>
                <polygon points="0,-10 -3,-85 0,-95 3,-85" fill="#b89828" transform="rotate(30)"></polygon>
                <polygon points="0,-10 -3,-85 0,-95 3,-85" fill="#b89828" transform="rotate(50)"></polygon>
                <polygon points="0,-10 -3,-85 0,-95 3,-85" fill="#b89828" transform="rotate(70)"></polygon>
                <polygon points="0,-10 -3,-85 0,-95 3,-85" fill="#b89828" transform="rotate(90)"></polygon>
                <polygon points="0,-10 -3,-85 0,-95 3,-85" fill="#b89828" transform="rotate(-10)"></polygon>
                <polygon points="0,-10 -3,-85 0,-95 3,-85" fill="#b89828" transform="rotate(-30)"></polygon>
                <polygon points="0,-10 -3,-85 0,-95 3,-85" fill="#b89828" transform="rotate(-50)"></polygon>
                <polygon points="0,-10 -3,-85 0,-95 3,-85" fill="#b89828" transform="rotate(-70)"></polygon>
                <polygon points="0,-10 -3,-85 0,-95 3,-85" fill="#b89828" transform="rotate(-90)"></polygon>
            </g>

            <!-- Dark blue orb behind crown -->
            <circle cx="138" cy="138" r="16" fill="#0e2660" stroke="#c8a82a" stroke-width="2.5"></circle>

            <!-- Tilted red cross (MOVED BEHIND CROWN) -->
            <g transform="translate(165,130) rotate(28)">
                <rect x="-10" y="-90" width="20" height="180" rx="3" fill="#fff"></rect>
                <rect x="-45" y="-38" width="90" height="20" rx="3" fill="#fff"></rect>
                <rect x="-7" y="-87" width="14" height="174" rx="2" fill="#cc1111"></rect>
                <rect x="-42" y="-35" width="84" height="14" rx="2" fill="#cc1111"></rect>
            </g>

            <!-- Crown body -->
            <g transform="translate(148,168)">
                <polygon points="-62,12 -54,-14 -38,4 -22,-22 -8,0 8,-22 22,4 38,-14 62,12" fill="url(#wmCrown)" stroke="#8a6e18" stroke-width="1.5"></polygon>
                <ellipse cx="0" cy="14" rx="62" ry="10" fill="url(#wmCrown)" stroke="#8a6e18" stroke-width="1.2"></ellipse>
                <rect x="-5" y="6" width="10" height="10" rx="2" fill="#cc1111" stroke="#900" stroke-width="1" transform="rotate(45,0,11)"></rect>
                <rect x="-30" y="7" width="8" height="8" rx="1.5" fill="#cc1111" stroke="#900" stroke-width="0.8" transform="rotate(45,-26,11)"></rect>
                <rect x="22" y="7" width="8" height="8" rx="1.5" fill="#cc1111" stroke="#900" stroke-width="0.8" transform="rotate(45,26,11)"></rect>
                <ellipse cx="0" cy="24" rx="55" ry="8" fill="#eef" stroke="#ccc" stroke-width="1"></ellipse>
                <ellipse cx="0" cy="23" rx="52" ry="6" fill="#fff" opacity="0.6"></ellipse>
            </g>

            <circle cx="86" cy="154" r="7" fill="#e0d8b0" stroke="#c8a82a" stroke-width="2"></circle>
            <circle cx="210" cy="154" r="7" fill="#e0d8b0" stroke="#c8a82a" stroke-width="2"></circle>
            <circle cx="110" cy="172" r="6" fill="#e0d8b0" stroke="#c8a82a" stroke-width="1.5"></circle>
            <circle cx="186" cy="172" r="6" fill="#e0d8b0" stroke="#c8a82a" stroke-width="1.5"></circle>
        </svg>
        <div class="day-headers">
            <span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span><span>Sun</span>
        </div>
        <div class="cal-grid" id="calGrid"><div class="cal-cell empty"></div><div class="cal-cell empty"></div><div class="cal-cell empty"></div><div class="cal-cell empty"></div><div class="cal-cell empty"></div><div class="cal-cell empty"></div><div class="cal-cell sunday past" onclick="openDayModal(1, 1)">
            <span class="day-num">1</span>
            
        </div><div class="cal-cell past" onclick="openDayModal(1, 2)">
            <span class="day-num">2</span>
            <div class="event-dots"><span class="event-dot dot-prayer"></span></div>
        </div><div class="cal-cell past" onclick="openDayModal(1, 3)">
            <span class="day-num">3</span>
            
        </div><div class="cal-cell past" onclick="openDayModal(1, 4)">
            <span class="day-num">4</span>
            
        </div><div class="cal-cell past" onclick="openDayModal(1, 5)">
            <span class="day-num">5</span>
            
        </div><div class="cal-cell past" onclick="openDayModal(1, 6)">
            <span class="day-num">6</span>
            
        </div><div class="cal-cell past" onclick="openDayModal(1, 7)">
            <span class="day-num">7</span>
            
        </div><div class="cal-cell sunday past" onclick="openDayModal(1, 8)">
            <span class="day-num">8</span>
            <div class="event-dots"><span class="event-dot dot-general"></span></div>
        </div><div class="cal-cell past" onclick="openDayModal(1, 9)">
            <span class="day-num">9</span>
            <div class="event-dots"><span class="event-dot dot-prayer"></span></div>
        </div><div class="cal-cell past" onclick="openDayModal(1, 10)">
            <span class="day-num">10</span>
            
        </div><div class="cal-cell past" onclick="openDayModal(1, 11)">
            <span class="day-num">11</span>
            
        </div><div class="cal-cell past" onclick="openDayModal(1, 12)">
            <span class="day-num">12</span>
            
        </div><div class="cal-cell past" onclick="openDayModal(1, 13)">
            <span class="day-num">13</span>
            
        </div><div class="cal-cell past" onclick="openDayModal(1, 14)">
            <span class="day-num">14</span>
            <div class="event-dots"><span class="event-dot dot-ladies"></span><span class="event-dot dot-national"></span></div>
        </div><div class="cal-cell sunday today" onclick="openDayModal(1, 15)">
            <span class="day-num">15</span>
            
        </div><div class="cal-cell" onclick="openDayModal(1, 16)">
            <span class="day-num">16</span>
            <div class="event-dots"><span class="event-dot dot-prayer"></span></div>
        </div><div class="cal-cell" onclick="openDayModal(1, 17)">
            <span class="day-num">17</span>
            
        </div><div class="cal-cell" onclick="openDayModal(1, 18)">
            <span class="day-num">18</span>
            
        </div><div class="cal-cell" onclick="openDayModal(1, 19)">
            <span class="day-num">19</span>
            
        </div><div class="cal-cell" onclick="openDayModal(1, 20)">
            <span class="day-num">20</span>
            
        </div><div class="cal-cell" onclick="openDayModal(1, 21)">
            <span class="day-num">21</span>
            <div class="event-dots"><span class="event-dot dot-men"></span></div>
        </div><div class="cal-cell sunday" onclick="openDayModal(1, 22)">
            <span class="day-num">22</span>
            <div class="event-dots"><span class="event-dot dot-ladies"></span><span class="event-dot dot-general"></span></div>
        </div><div class="cal-cell" onclick="openDayModal(1, 23)">
            <span class="day-num">23</span>
            <div class="event-dots"><span class="event-dot dot-prayer"></span></div>
        </div><div class="cal-cell" onclick="openDayModal(1, 24)">
            <span class="day-num">24</span>
            
        </div><div class="cal-cell" onclick="openDayModal(1, 25)">
            <span class="day-num">25</span>
            
        </div><div class="cal-cell" onclick="openDayModal(1, 26)">
            <span class="day-num">26</span>
            
        </div><div class="cal-cell" onclick="openDayModal(1, 27)">
            <span class="day-num">27</span>
            
        </div><div class="cal-cell" onclick="openDayModal(1, 28)">
            <span class="day-num">28</span>
            <div class="event-dots"><span class="event-dot dot-men"></span><span class="event-dot dot-ladies"></span></div>
        </div></div>

        <!-- Legend -->
        <div class="legend">
            <div class="legend-item"><span class="legend-dot" style="background:#e94560"></span>General</div>
            <div class="legend-item"><span class="legend-dot" style="background:#E91E63"></span>Ladies</div>
            <div class="legend-item"><span class="legend-dot" style="background:#1565C0"></span>Men</div>
            <div class="legend-item"><span class="legend-dot" style="background:#FF9800"></span>Youth</div>
            <div class="legend-item"><span class="legend-dot" style="background:#4CAF50"></span>S. School</div>
            <div class="legend-item"><span class="legend-dot" style="background:#7B1FA2"></span>National</div>
            <div class="legend-item"><span class="legend-dot" style="background:#78909C"></span>Prayer</div>
        </div>

        <!-- Event list for month -->
        <div class="month-events" id="monthEvents"><h3>February 2026 ‚Äî Events</h3><div class="event-item" onclick="showActivityInfo('Prayer and Fasting')">
            <div class="event-date-badge bg-prayer">MON</div>
            <div class="event-info">
                <div class="event-title">Prayer &amp; Fasting (Every Monday)</div>
                <div class="event-dept">Weekly ¬∑ Dates: 2, 9, 16, 23</div>
            </div>
            <div class="info-icon" title="What is this?">?</div>
        </div><div class="event-item" onclick="openDayModal(1, 8)">
            <div class="event-date-badge bg-general">8</div>
            <div class="event-info">
                <div class="event-title">Holy Communion</div>
                <div class="event-dept">Sunday ¬∑ General</div>
                <div class="event-service">
                    üé§ Mr Dube ¬∑ üìñ Pastor C Mudada
                </div>
            </div>
            <div class="info-icon" onclick="event.stopPropagation();showActivityInfo('Holy Communion')">?</div>
        </div><div class="event-item" onclick="openDayModal(1, 14)">
            <div class="event-date-badge bg-ladies">14</div>
            <div class="event-info">
                <div class="event-title">National Ladies Leadership Meeting</div>
                <div class="event-dept">Saturday ¬∑ Ladies &amp; National</div>
                
            </div>
            <div class="info-icon" onclick="event.stopPropagation();showActivityInfo('National Ladies Leadership Meeting')">?</div>
        </div><div class="event-item" onclick="openDayModal(1, 21)">
            <div class="event-date-badge bg-men">21</div>
            <div class="event-info">
                <div class="event-title">Men's Breakfast Meeting</div>
                <div class="event-dept">Saturday ¬∑ Men</div>
                
            </div>
            <div class="info-icon" onclick="event.stopPropagation();showActivityInfo('Men\'s Breakfast Meeting')">?</div>
        </div><div class="event-item" onclick="openDayModal(1, 22)">
            <div class="event-date-badge bg-ladies">22</div>
            <div class="event-info">
                <div class="event-title">Ladies Special Sunday</div>
                <div class="event-dept">Sunday ¬∑ Ladies</div>
                <div class="event-service">
                    üé§ Mrs V Dube ¬∑ üìñ Mrs Pastor L Mudada
                </div>
            </div>
            <div class="info-icon" onclick="event.stopPropagation();showActivityInfo('Ladies Special Sunday')">?</div>
        </div><div class="event-item" onclick="openDayModal(1, 22)">
            <div class="event-date-badge bg-general">22</div>
            <div class="event-info">
                <div class="event-title">Holy Communion</div>
                <div class="event-dept">Sunday ¬∑ General</div>
                <div class="event-service">
                    üé§ Mrs V Dube ¬∑ üìñ Mrs Pastor L Mudada
                </div>
            </div>
            <div class="info-icon" onclick="event.stopPropagation();showActivityInfo('Holy Communion')">?</div>
        </div><div class="event-item" onclick="openDayModal(1, 28)">
            <div class="event-date-badge bg-men">28</div>
            <div class="event-info">
                <div class="event-title">Couples Meeting</div>
                <div class="event-dept">Saturday ¬∑ Men &amp; Ladies</div>
                
            </div>
            <div class="info-icon" onclick="event.stopPropagation();showActivityInfo('Couples Meeting')">?</div>
        </div></div>
    </div>

    <!-- ============ MODAL ============ -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeModalOutside(event)">
        <div class="modal" id="modalContent"></div>
    </div>

    <!-- ============ ADMIN TOGGLE ============ -->
    <button class="admin-toggle" onclick="toggleAdmin()" title="Secretary Panel">‚öô</button>
    <button class="admin-toggle" style="bottom:80px;background:#1565C0;" onclick="showHelp()" title="Help &amp; Guide">?</button>
    <div class="admin-panel" id="adminPanel">
        <div style="display:flex;justify-content:space-between;align-items:center;">
            <h3 style="margin:0;">‚öô Secretary Panel</h3>
            <button onclick="document.getElementById('adminPanel').classList.remove('active')" style="background:none;border:none;font-size:1.3rem;cursor:pointer;color:#888;padding:0 4px;" title="Close Panel">√ó</button>
        </div>
        <p style="font-size:0.7rem;color:#888;margin-bottom:10px;">Manage assignments &amp; confirmations</p>
        <label style="font-size:0.75rem;font-weight:600;">Quick Actions:</label>
        <button class="btn btn-edit" style="width:100%;margin:6px 0;" onclick="showAllPendingModal()">View All
            Pending</button>
        <button class="btn btn-whatsapp" style="width:100%;margin:6px 0;" onclick="shareMonthCalendar()">üì± Share Month
            via WhatsApp</button>
        <button class="btn btn-confirm" style="width:100%;margin:6px 0;" onclick="exportData()">üíæ Export Data
            (Backup)</button>
        <button class="btn btn-reschedule" style="width:100%;margin:6px 0;" onclick="importDataPrompt()">üìÇ Import Data
            (Restore)</button>
        <hr style="margin:10px 0;border:none;border-top:1px solid #eee;">
        <label style="font-size:0.75rem;font-weight:600;color:#007bff;">Publish to Live Website:</label>
        <p style="font-size:0.65rem;color:#aaa;margin:4px 0 6px;">Pushes your current rota directly to GitHub Pages.</p>
        <button class="btn btn-whatsapp" style="width:100%;margin:6px 0;background:#007bff;" onclick="publishToGitHub()" id="publishBtn" disabled="">‚è≥ Publishing...</button>
        <button class="btn btn-close" style="width:100%;margin:2px 0;font-size:0.65rem;" onclick="setupGitHub()">‚öô
            Settings (WhatsApp &amp; GitHub)</button>
        <hr style="margin:10px 0;border:none;border-top:1px solid #eee;">
        <label style="font-size:0.75rem;font-weight:600;color:#FF9800;">Delegation:</label>
        <p style="font-size:0.65rem;color:#aaa;margin:4px 0 6px;">Hand over calendar management to the Pastor when
            you're unavailable.</p>
        <button class="btn btn-edit" style="width: 100%; margin: 6px 0px;" onclick="toggleDelegation()" id="delegateBtn">üì° Delegate Duties to Pastor</button>
        <hr style="margin:10px 0;border:none;border-top:1px solid #eee;">
        <label style="font-size:0.75rem;font-weight:600;color:#9C27B0;">Allocation Matrix:</label>
        <p style="font-size:0.65rem;color:#aaa;margin:4px 0 6px;">View the year-end balance of preaching &amp; facilitation
            duties across all members.</p>
        <button class="btn btn-confirm" style="width:100%;margin:6px 0;background:#9C27B0;" onclick="showAllocationMatrix()">üìä View Allocation Matrix</button>
        <hr style="margin:10px 0;border:none;border-top:1px solid #eee;">
        <label style="font-size:0.75rem;font-weight:600;">Reset:</label>
        <button class="btn btn-decline" style="width:100%;margin:6px 0;" onclick="if(confirm('Reset ALL assignments and confirmations?\n\nYour settings (GitHub token, phone numbers) will be kept.')){resetAssignmentsOnly();}">üîÑ
            Reset All Data</button>
    </div>

    <!-- ============ WHATSAPP SHARE ============ -->
    <div class="share-bar">
        <button onclick="shareMonthCalendar()" title="Share on WhatsApp">üì±</button>
    </div>

    <!-- ============ TOAST ============ -->
    <div class="toast" id="toast">üîì Welcome, Secretary!</div>

    <script>
        // ============================================================
        //  DATA: MEMBERS
        // ============================================================
        const MEMBERS = [
            { id: 1, name: "Pastor C Mudada", role: "Pastor", canPreach: true, canFacilitate: true, dept: "general", available: "always" },
            { id: 2, name: "Mrs Pastor L Mudada", role: "Pastor's Wife", canPreach: true, canFacilitate: true, dept: "ladies", available: "always" },
            { id: 3, name: "Sister Makanaka Mudada", role: "Member", canPreach: false, canFacilitate: true, dept: "youth", available: "always", age: 14 },
            { id: 4, name: "Brother Panayote Mudada", role: "Member", canPreach: true, canFacilitate: true, dept: "youth", available: "college-breaks", age: 18, note: "At college in Dundalk during term" },
            { id: 5, name: "Mr Dube", role: "Church Administrator", canPreach: true, canFacilitate: true, dept: "general", available: "always" },
            { id: 6, name: "Mrs V Dube", role: "Member", canPreach: true, canFacilitate: true, dept: "ladies", available: "always" },
            { id: 7, name: "Dube Daughter 1", role: "Member", canPreach: true, canFacilitate: true, dept: "youth", available: "always", age: 20 },
            { id: 8, name: "Dube Daughter 2", role: "Member", canPreach: false, canFacilitate: true, dept: "youth", available: "always", age: 16 },
            { id: 9, name: "Dube Son", role: "Junior Member", canPreach: false, canFacilitate: false, dept: "sunday-school", available: "always", age: 13 },
            { id: 10, name: "Sister Eve", role: "Member", canPreach: true, canFacilitate: true, dept: "ladies", available: "always" },
            { id: 11, name: "Sister Emily", role: "Member", canPreach: true, canFacilitate: true, dept: "ladies", available: "always" },
            { id: 12, name: "Mr V Gill", role: "Youth Leader", canPreach: true, canFacilitate: true, dept: "youth", available: "always" },
            { id: 13, name: "Mrs S Gill", role: "Sunday School Supt", canPreach: true, canFacilitate: true, dept: "sunday-school", available: "always" },
            { id: 14, name: "Mr T Ncube", role: "Secretary", canPreach: true, canFacilitate: true, dept: "general", available: "always" },
            { id: 15, name: "Mrs F Ncube", role: "Ladies' Secretary", canPreach: true, canFacilitate: true, dept: "ladies", available: "always" },
            { id: 16, name: "Sister Thandiwe Ncube", role: "Member", canPreach: true, canFacilitate: true, dept: "youth", available: "always", age: 18 },
            { id: 17, name: "Brother Imanathi Ncube", role: "Member", canPreach: false, canFacilitate: true, dept: "youth", available: "always", age: 16.5 },
            { id: 18, name: "Brother Thulani Aviel Ncube", role: "Junior Member", canPreach: false, canFacilitate: false, dept: "sunday-school", available: "always", age: 9.5 },
            { id: 19, name: "Brother Siyanqoba Hadriel Ncube", role: "Junior Member", canPreach: false, canFacilitate: false, dept: "sunday-school", available: "always", age: 6.5 }
        ];

        // ============================================================
        //  DATA: ACTIVITY DESCRIPTIONS (for pop-ups)
        // ============================================================
        const ACTIVITY_INFO = {
            "Prayer and Fasting": "A dedicated time of seeking God through prayer and abstaining from food. Members are encouraged to participate individually or as families.",
            "Holy Communion": "The Lord's Supper ‚Äî a sacred ordinance where believers partake of bread and wine/juice in remembrance of Christ's sacrifice (1 Corinthians 11:23-26).",
            "Theme Unveiling": "The annual event where the church's spiritual theme and focus for the year is revealed by the Pastor. This theme guides all activities and teachings for the year.",
            "Leadership Meeting": "A quarterly gathering of church leaders (Pastor, Administrator, Secretary, Department Heads) to discuss church direction, planning, and operational matters.",
            "National Ladies Leadership Meeting": "A national gathering organised by AFM Ireland for all ladies' leaders across assemblies to strategise, plan, and fellowship.",
            "Men's Breakfast Meeting": "A fellowship breakfast for men in the church ‚Äî a time for bonding, mentorship, Bible discussion, and planning men's department activities.",
            "Couples Meeting": "A special gathering for married couples focusing on strengthening marriages through Biblical teaching, sharing, and prayer.",
            "Special Sunday Service": "A department-led service where the assigned department (Ladies, Men, Youth, or Sunday School) takes charge of the entire service ‚Äî from worship to preaching.",
            "Easter Conference": "A multi-day conference over the Easter weekend featuring special teachings, worship, and celebration of Christ's resurrection.",
            "National Annual General Conference": "The annual AGM for all AFM Ireland assemblies. Includes reports, elections, national planning, and fellowship.",
            "National Youth Camp Revival": "A national youth retreat/camp featuring worship, teaching, recreation, and spiritual revival for young people across AFM Ireland.",
            "National Annual Youth Conference": "The annual national conference specifically for youth across AFM Ireland, featuring workshops, worship, and leadership development.",
            "National Ladies Conference": "A multi-day national conference for ladies across AFM Ireland, featuring teachings, workshops, and fellowship.",
            "Ladies Conference Galway": "A ladies' conference hosted locally by the Galway Assembly ‚Äî a time of teaching, fellowship, and empowerment for women.",
            "National Ladies Mentoring BBQ": "An informal national mentoring event for ladies combining food, fellowship, and intergenerational mentorship.",
            "Ladies Special Sunday": "The Ladies Department leads the entire Sunday service ‚Äî selecting songs, the facilitator/chairperson, the preacher, and managing all aspects of worship.",
            "Men's Special Sunday": "The Men's Department leads the entire Sunday service ‚Äî they choose the worship, facilitator, preacher, and run all service elements.",
            "Youth Special Sunday": "The Youth Department leads the entire Sunday service ‚Äî a chance for young people to showcase their gifts in worship, preaching, and service leadership.",
            "Sunday School Special Sunday": "The Sunday School Department leads the service ‚Äî children and teachers participate in worship, presentations, and ministry, showcasing what they've learned."
        };

        // ============================================================
        //  DATA: EVENTS
        // ============================================================
        function generateEvents(year) {
            const events = [];
            // dept can be a string OR an array of strings for multi-dept events
            const addEv = (m, d, title, dept, endDay) => {
                const depts = Array.isArray(dept) ? dept : [dept];
                events.push({ month: m, day: d, endDay: endDay || d, title, dept: depts[0], depts, key: `${m}-${d}-${title}` });
            };

            if (year === 2026) {
                // ---- JANUARY ----
                addEv(0, 1, "Prayer and Fasting (10 Days)", "general", 10);
                addEv(0, 4, "Theme Unveiling", "general");
                addEv(0, 4, "Leadership Meeting", "general");
                addEv(0, 11, "Holy Communion", "general");
                addEv(0, 17, "National Ladies Leadership Meeting", ["ladies", "national"]);
                addEv(0, 25, "Holy Communion", "general");

                // ---- FEBRUARY ----
                addEv(1, 8, "Holy Communion", "general");
                addEv(1, 14, "National Ladies Leadership Meeting", ["ladies", "national"]);
                addEv(1, 21, "Men's Breakfast Meeting", "men");
                addEv(1, 22, "Ladies Special Sunday", "ladies");
                addEv(1, 22, "Holy Communion", "general");
                addEv(1, 28, "Couples Meeting", ["men", "ladies"]);

                // ---- MARCH ----
                addEv(2, 8, "Holy Communion", "general");
                addEv(2, 14, "National Ladies Leadership Meeting", ["ladies", "national"]);
                addEv(2, 22, "Holy Communion", "general");
                addEv(2, 29, "Sunday School Special Sunday", "sunday-school");
                addEv(2, 29, "Holy Communion", "general");

                // ---- APRIL ----
                addEv(3, 2, "Easter Conference", "general", 5);
                addEv(3, 5, "Holy Communion", "general");
                addEv(3, 18, "National Ladies Leadership Meeting", ["ladies", "national"]);
                addEv(3, 25, "Leadership Meeting", "general");
                addEv(3, 26, "Men's Special Sunday", "men");
                addEv(3, 26, "Holy Communion", "general");

                // ---- MAY ----
                addEv(4, 2, "National Ladies Leadership Meeting", ["ladies", "national"]);
                addEv(4, 10, "Holy Communion", "general");
                addEv(4, 24, "Ladies Special Sunday", "ladies");
                addEv(4, 24, "Holy Communion", "general");
                addEv(4, 31, "Holy Communion", "general");

                // ---- JUNE ----
                addEv(5, 1, "Prayer and Fasting (10 Days)", "general", 10);
                addEv(5, 14, "Holy Communion", "general");
                addEv(5, 27, "National Youth Camp Revival", ["youth", "national"], 28);
                addEv(5, 28, "Holy Communion", "general");

                // ---- JULY ----
                addEv(6, 4, "National Ladies Mentoring BBQ", ["ladies", "national"]);
                addEv(6, 5, "Holy Communion", "general");
                addEv(6, 19, "Youth Special Sunday", "youth");
                addEv(6, 19, "Holy Communion", "general");
                addEv(6, 20, "Leadership Meeting", "general");
                addEv(6, 24, "National Annual General Conference", ["general", "national"], 26);
                addEv(6, 25, "Men's Breakfast Meeting", "men");
                addEv(6, 26, "Holy Communion", "general");

                // ---- AUGUST ----
                addEv(7, 8, "National Ladies Leadership Meeting", ["ladies", "national"]);
                addEv(7, 9, "Holy Communion", "general");
                addEv(7, 23, "Ladies Special Sunday", "ladies");
                addEv(7, 23, "Holy Communion", "general");
                addEv(7, 30, "Holy Communion", "general");

                // ---- SEPTEMBER ----
                addEv(8, 12, "National Ladies Leadership Meeting", ["ladies", "national"]);
                addEv(8, 13, "Holy Communion", "general");
                addEv(8, 25, "National Annual Youth Conference", ["youth", "national"], 27);
                addEv(8, 27, "Holy Communion", "general");

                // ---- OCTOBER ----
                addEv(9, 9, "National Ladies Conference", ["ladies", "national"], 11);
                addEv(9, 11, "Holy Communion", "general");
                addEv(9, 25, "Men's Special Sunday", "men");
                addEv(9, 25, "Holy Communion", "general");
                addEv(9, 25, "Leadership Meeting", "general");

                // ---- NOVEMBER ----
                addEv(10, 1, "Holy Communion", "general");
                addEv(10, 7, "National Ladies Mentoring BBQ", ["ladies", "national"]);
                addEv(10, 8, "Holy Communion", "general");
                addEv(10, 21, "Ladies Conference Galway", "ladies", 23);
                addEv(10, 22, "Ladies Special Sunday", "ladies");
                addEv(10, 22, "Holy Communion", "general");
                addEv(10, 29, "Holy Communion", "general");
                addEv(10, 30, "Leadership Meeting", "general");

                // ---- DECEMBER ----
                addEv(11, 5, "National Ladies Leadership Meeting", ["ladies", "national"]);
                addEv(11, 6, "Holy Communion", "general");
                addEv(11, 13, "Holy Communion", "general");
                addEv(11, 27, "Youth Special Sunday", "youth");
                addEv(11, 27, "Holy Communion", "general");
                addEv(11, 27, "Men's Breakfast Meeting", "men");
            } else {
                // Placeholder for future years
                addEv(0, 1, "‚ö†Ô∏è UPDATE CALENDAR FOR " + year, "general");
            }

            // ---- PRAYER AND FASTING: Every Monday throughout the year ----
            for (let m = 0; m < 12; m++) {
                const daysInMonth = new Date(year, m + 1, 0).getDate();
                for (let d = 1; d <= daysInMonth; d++) {
                    const dow = new Date(year, m, d).getDay(); // 0=Sun, 1=Mon
                    if (dow === 1) {
                        // Skip if within Jan 1-10 or Jun 1-10 extended periods (assuming recurrence)
                        if (year === 2026 && ((m === 0 && d <= 10) || (m === 5 && d <= 10))) continue;
                        addEv(m, d, "Prayer and Fasting", "prayer");
                    }
                }
            }

            return events;
        }

        let EVENTS;

        // ============================================================
        //  DATA: SUNDAY ASSIGNMENTS (Facilitator + Preacher)
        // ============================================================
        function getAllSundays(year) {
            const sundays = [];
            for (let m = 0; m < 12; m++) {
                const daysInMonth = new Date(year, m + 1, 0).getDate();
                for (let d = 1; d <= daysInMonth; d++) {
                    if (new Date(year, m, d).getDay() === 0) {
                        sundays.push({ month: m, day: d });
                    }
                }
            }
            return sundays;
        }

        // Check if Panayote is available (college breaks only)
        function isPanayoteAvailable(month) {
            // Available: mid-Dec to late Jan (Christmas break), June-August (summer)
            // At college: Feb-May, Sep-Nov
            return month === 0 || month === 5 || month === 6 || month === 7 || month === 11;
        }

        // ============================================================
        //  FIXED ASSIGNMENTS: Override specific Sundays
        // ============================================================
        const FIXED_ASSIGNMENTS = {
            '1-15': { preacherId: 1, facilitatorId: 5 }   // Feb 15 ‚Äî Pastor C Mudada preaches, Mr Dube facilitates
        };

        // ============================================================
        //  HOLY COMMUNION: Preacher Constraint
        // ============================================================
        // Returns true if this Sunday has a Holy Communion event
        function isHolyCommunionSunday(month, day) {
            return EVENTS.some(e => e.month === month && e.day === day && e.title === 'Holy Communion');
        }

        // ============================================================
        //  SPECIAL SUNDAYS: Department-Led Service Rules
        // ============================================================
        // Returns the department string if this Sunday is a Special Sunday, or null
        function getSpecialSundayDept(month, day) {
            const dayEvents = EVENTS.filter(e => e.month === month && e.day === day);
            const special = dayEvents.find(e =>
                e.title.includes('Special Sunday')
            );
            return special ? special.dept : null;
        }

        // Get department leader for a Special Sunday
        function getDeptLeader(dept) {
            switch (dept) {
                case 'ladies': return 2;    // Mrs Pastor L Mudada (Ladies Leader)
                case 'youth': return 12;    // Mr V Gill (Youth Leader)
                case 'sunday-school': return 13; // Mrs S Gill (Sunday School Supt)
                case 'men': return 5;       // Mr Dube (Church Administrator / Men)
                default: return null;
            }
        }

        // Get department members eligible for a role
        function getDeptMembers(dept, role) {
            const isPreach = role === 'preacher';
            // For men's dept, include 'general' dept males who are men (Mr Dube id:5, Mr T Ncube id:14)
            // and Mr V Gill (id:12) who is Youth Leader but also a man
            if (dept === 'men') {
                const menIds = [5, 14, 12]; // Mr Dube, Mr T Ncube, Mr V Gill
                return MEMBERS.filter(m => {
                    if (!menIds.includes(m.id)) return false;
                    if (isPreach && !m.canPreach) return false;
                    if (!isPreach && !m.canFacilitate) return false;
                    return true;
                });
            }
            // For sunday-school on Special Sunday:
            // Preacher = Mrs S Gill (Supt), Facilitator = can be children/teachers
            if (dept === 'sunday-school') {
                if (isPreach) {
                    // Only Mrs S Gill preaches on SS Special Sunday
                    return MEMBERS.filter(m => m.id === 13);
                } else {
                    // Children and teachers can facilitate (special once-a-year allowance)
                    return MEMBERS.filter(m => m.dept === 'sunday-school');
                }
            }
            // Ladies and Youth: filter by department
            return MEMBERS.filter(m => {
                if (m.dept !== dept) return false;
                if (isPreach && !m.canPreach) return false;
                if (!isPreach && !m.canFacilitate) return false;
                return true;
            });
        }

        // ============================================================
        //  ALLOCATION ENGINE: Balanced Fair-Distribution Algorithm
        // ============================================================
        //  Rules:
        //  ‚Ä¢ 14+ can facilitate, 18+ can preach
        //  ‚Ä¢ No person on the SAME role two consecutive Sundays
        //  ‚Ä¢ Pastor: ~2 preaching slots/month (max 3), always in alternatives
        //  ‚Ä¢ Adults = heavy allocation, Youth = moderate, SS children = excluded
        //  ‚Ä¢ Special Sundays = department members only (that ONE Sunday)
        //  ‚Ä¢ By 31 Dec allocation must be roughly balanced
        // ============================================================

        function getMemberTier(member) {
            if (!member.age) return 'adult';
            if (['Youth Leader', 'Sunday School Supt'].includes(member.role)) return 'adult';
            if (member.age >= 18) return 'young-adult';
            if (member.age >= 14) return 'youth';
            return 'child';
        }

        function getPreacherWeight(m) {
            if (!m.canPreach) return 0;
            if (m.id === 1) return 28;       // Pastor: ~2/month
            if (m.id === 4) return 1;        // Panayote: limited
            const t = getMemberTier(m);
            if (t === 'adult') return 2.5;
            if (t === 'young-adult') return 1.5;
            return 0;
        }

        function getFacilitatorWeight(m) {
            if (!m.canFacilitate) return 0;
            if (m.id === 1) return 2;        // Pastor: light (preaches a lot)
            if (m.id === 4) return 1;        // Panayote: limited
            const t = getMemberTier(m);
            if (t === 'adult') return 3.5;
            if (t === 'young-adult') return 2.5;
            if (t === 'youth') return 2;
            return 0;
        }

        function pickCandidate(pool, lastId, excludeId, month, pastorMonthCap) {
            // Filter available candidates
            let candidates = pool.filter(p => {
                if (p.id === excludeId) return false;
                if (p.id === 4 && !isPanayoteAvailable(month)) return false;
                return true;
            });
            // Prefer non-consecutive
            const nonConsec = candidates.filter(p => p.id !== lastId);
            if (nonConsec.length > 0) candidates = nonConsec;
            // Pastor monthly cap (soft=2, hard=3)
            if (pastorMonthCap) {
                const capped = candidates.filter(p => {
                    if (p.id === 1 && (p.monthly[month] || 0) >= 2) return false;
                    return true;
                });
                if (capped.length > 0) candidates = capped;
                // If still none, allow up to 3
                if (candidates.length === 0) {
                    candidates = pool.filter(p => {
                        if (p.id === excludeId) return false;
                        if (p.id === 4 && !isPanayoteAvailable(month)) return false;
                        if (p.id === 1 && (p.monthly[month] || 0) >= 3) return false;
                        return true;
                    });
                }
            }
            if (candidates.length === 0) {
                candidates = pool.filter(p => p.id !== excludeId);
            }

            // Safety check: if still empty (e.g. strict filters), fallback to full pool
            if (candidates.length === 0) {
                candidates = pool;
            }
            // If absolute failure (empty pool), return default ID (1=Pastor) or handle gracefully
            if (candidates.length === 0) return 1;

            // Sort by deficit: most under-served first
            candidates.sort((a, b) => {
                const ra = a.target > 0 ? a.count / a.target : 999;
                const rb = b.target > 0 ? b.count / b.target : 999;
                return ra - rb;
            });
            return candidates[0].id;
        }

        function generateInitialAssignments() {
            const sundays = getAllSundays(currentYear);
            const saved = localStorage.getItem('afm_assignments');
            if (saved) return JSON.parse(saved);

            // Build pools with weights
            const preacherPool = MEMBERS.filter(m => getPreacherWeight(m) > 0).map(m => ({
                id: m.id, weight: getPreacherWeight(m), count: 0, monthly: {}
            }));
            const facilitatorPool = MEMBERS.filter(m => getFacilitatorWeight(m) > 0).map(m => ({
                id: m.id, weight: getFacilitatorWeight(m), count: 0, monthly: {}
            }));

            // Count normal (non-Special) Sundays and compute targets
            const normalCount = sundays.filter(s => !getSpecialSundayDept(s.month, s.day)).length;
            const totalPW = preacherPool.reduce((s, p) => s + p.weight, 0);
            const totalFW = facilitatorPool.reduce((s, p) => s + p.weight, 0);
            preacherPool.forEach(p => { p.target = Math.max(1, Math.round(normalCount * p.weight / totalPW)); });
            facilitatorPool.forEach(p => { p.target = Math.max(1, Math.round(normalCount * p.weight / totalFW)); });

            let lastPreacherId = -1, lastFacilitatorId = -1;
            const specialDeptCounters = {};
            const assignments = {};

            let holyCommunionToggle = 0; // alternates preacher between Pastor(1) and Mr Dube(5)

            sundays.forEach(s => {
                const key = `${s.month}-${s.day}`;
                const specialDept = getSpecialSundayDept(s.month, s.day);
                const fixed = FIXED_ASSIGNMENTS[key];
                const holyCommunion = isHolyCommunionSunday(s.month, s.day);
                let preacherId, facilitatorId;

                if (fixed) {
                    // ‚îÄ‚îÄ‚îÄ FIXED ASSIGNMENT: Manually overridden Sunday ‚îÄ‚îÄ‚îÄ
                    preacherId = fixed.preacherId;
                    facilitatorId = fixed.facilitatorId;
                } else if (specialDept) {
                    // ‚îÄ‚îÄ‚îÄ SPECIAL SUNDAY: Department members only (this day only) ‚îÄ‚îÄ‚îÄ
                    const leader = getDeptLeader(specialDept);
                    const dp = getDeptMembers(specialDept, 'preacher');
                    const df = getDeptMembers(specialDept, 'facilitator');
                    preacherId = (leader && dp.find(m => m.id === leader)) ? leader : (dp.length ? dp[0].id : 1);
                    const ef = df.filter(m => m.id !== preacherId);
                    specialDeptCounters[specialDept] = (specialDeptCounters[specialDept] || 0);
                    if (ef.length > 0) {
                        facilitatorId = ef[specialDeptCounters[specialDept] % ef.length].id;
                        specialDeptCounters[specialDept]++;
                    } else {
                        facilitatorId = df.length ? df[0].id : preacherId;
                    }
                    // Don't affect normal-Sunday counters
                } else if (holyCommunion) {
                    // ‚îÄ‚îÄ‚îÄ HOLY COMMUNION: Pastor C Mudada or Mr Dube must preach ‚îÄ‚îÄ‚îÄ
                    const hcPreachers = [1, 5]; // Pastor C Mudada, Mr Dube
                    preacherId = hcPreachers[holyCommunionToggle % 2];
                    holyCommunionToggle++;
                    // Facilitator from normal pool (exclude preacher)
                    facilitatorId = pickCandidate(facilitatorPool, lastFacilitatorId, preacherId, s.month, false);
                    const fp = facilitatorPool.find(p => p.id === facilitatorId);
                    if (fp) { fp.count++; fp.monthly[s.month] = (fp.monthly[s.month] || 0) + 1; }
                    lastFacilitatorId = facilitatorId;
                } else {
                    // ‚îÄ‚îÄ‚îÄ NORMAL SUNDAY: Balanced allocation ‚îÄ‚îÄ‚îÄ
                    preacherId = pickCandidate(preacherPool, lastPreacherId, -1, s.month, true);
                    facilitatorId = pickCandidate(facilitatorPool, lastFacilitatorId, preacherId, s.month, false);

                    const pp = preacherPool.find(p => p.id === preacherId);
                    pp.count++; pp.monthly[s.month] = (pp.monthly[s.month] || 0) + 1;
                    const fp = facilitatorPool.find(p => p.id === facilitatorId);
                    fp.count++; fp.monthly[s.month] = (fp.monthly[s.month] || 0) + 1;

                    lastPreacherId = preacherId;
                    lastFacilitatorId = facilitatorId;
                }

                assignments[key] = {
                    preacher: { memberId: preacherId, status: 'pending', rescheduleCount: 0 },
                    facilitator: { memberId: facilitatorId, status: 'pending', rescheduleCount: 0 }
                };
            });

            localStorage.setItem('afm_assignments', JSON.stringify(assignments));
            return assignments;
        }

        // ============================================================
        //  STATE
        // ============================================================
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        if (currentYear < 2026) currentYear = 2026;

        // Initialize dynamic events
        EVENTS = generateEvents(currentYear);

        let activeFilter = 'all';
        let assignments = {"0-4":{"preacher":{"memberId":1,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":2,"status":"pending","rescheduleCount":0}},"0-11":{"preacher":{"memberId":1,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":3,"status":"pending","rescheduleCount":0}},"0-18":{"preacher":{"memberId":2,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":1,"status":"pending","rescheduleCount":0}},"0-25":{"preacher":{"memberId":5,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":4,"status":"pending","rescheduleCount":0}},"1-1":{"preacher":{"memberId":5,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":6,"status":"pending","rescheduleCount":0}},"1-8":{"preacher":{"memberId":1,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":5,"status":"pending","rescheduleCount":0}},"1-15":{"preacher":{"memberId":1,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":5,"status":"pending","rescheduleCount":0}},"1-22":{"preacher":{"memberId":2,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":6,"status":"pending","rescheduleCount":0}},"2-1":{"preacher":{"memberId":6,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":7,"status":"pending","rescheduleCount":0}},"2-8":{"preacher":{"memberId":5,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":8,"status":"pending","rescheduleCount":0}},"2-15":{"preacher":{"memberId":7,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":10,"status":"pending","rescheduleCount":0}},"2-22":{"preacher":{"memberId":1,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":11,"status":"pending","rescheduleCount":0}},"2-29":{"preacher":{"memberId":13,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":9,"status":"pending","rescheduleCount":0}},"3-5":{"preacher":{"memberId":5,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":12,"status":"pending","rescheduleCount":0}},"3-12":{"preacher":{"memberId":10,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":13,"status":"pending","rescheduleCount":0}},"3-19":{"preacher":{"memberId":11,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":14,"status":"pending","rescheduleCount":0}},"3-26":{"preacher":{"memberId":5,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":12,"status":"pending","rescheduleCount":0}},"4-3":{"preacher":{"memberId":12,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":15,"status":"pending","rescheduleCount":0}},"4-10":{"preacher":{"memberId":1,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":16,"status":"pending","rescheduleCount":0}},"4-17":{"preacher":{"memberId":13,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":17,"status":"pending","rescheduleCount":0}},"4-24":{"preacher":{"memberId":2,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":10,"status":"pending","rescheduleCount":0}},"4-31":{"preacher":{"memberId":5,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":2,"status":"pending","rescheduleCount":0}},"5-7":{"preacher":{"memberId":4,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":5,"status":"pending","rescheduleCount":0}},"5-14":{"preacher":{"memberId":1,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":6,"status":"pending","rescheduleCount":0}},"5-21":{"preacher":{"memberId":14,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":10,"status":"pending","rescheduleCount":0}},"5-28":{"preacher":{"memberId":5,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":11,"status":"pending","rescheduleCount":0}},"6-5":{"preacher":{"memberId":1,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":12,"status":"pending","rescheduleCount":0}},"6-12":{"preacher":{"memberId":15,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":13,"status":"pending","rescheduleCount":0}},"6-19":{"preacher":{"memberId":12,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":3,"status":"pending","rescheduleCount":0}},"6-26":{"preacher":{"memberId":5,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":14,"status":"pending","rescheduleCount":0}},"7-2":{"preacher":{"memberId":16,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":15,"status":"pending","rescheduleCount":0}},"7-9":{"preacher":{"memberId":1,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":3,"status":"pending","rescheduleCount":0}},"7-16":{"preacher":{"memberId":1,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":7,"status":"pending","rescheduleCount":0}},"7-23":{"preacher":{"memberId":2,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":11,"status":"pending","rescheduleCount":0}},"7-30":{"preacher":{"memberId":5,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":1,"status":"pending","rescheduleCount":0}},"8-6":{"preacher":{"memberId":2,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":8,"status":"pending","rescheduleCount":0}},"8-13":{"preacher":{"memberId":1,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":16,"status":"pending","rescheduleCount":0}},"8-20":{"preacher":{"memberId":1,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":17,"status":"pending","rescheduleCount":0}},"8-27":{"preacher":{"memberId":5,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":2,"status":"pending","rescheduleCount":0}},"9-4":{"preacher":{"memberId":5,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":6,"status":"pending","rescheduleCount":0}},"9-11":{"preacher":{"memberId":1,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":5,"status":"pending","rescheduleCount":0}},"9-18":{"preacher":{"memberId":1,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":10,"status":"pending","rescheduleCount":0}},"9-25":{"preacher":{"memberId":5,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":14,"status":"pending","rescheduleCount":0}},"10-1":{"preacher":{"memberId":5,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":11,"status":"pending","rescheduleCount":0}},"10-8":{"preacher":{"memberId":1,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":12,"status":"pending","rescheduleCount":0}},"10-15":{"preacher":{"memberId":6,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":13,"status":"pending","rescheduleCount":0}},"10-22":{"preacher":{"memberId":2,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":15,"status":"pending","rescheduleCount":0}},"10-29":{"preacher":{"memberId":5,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":14,"status":"pending","rescheduleCount":0}},"11-6":{"preacher":{"memberId":1,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":15,"status":"pending","rescheduleCount":0}},"11-13":{"preacher":{"memberId":5,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":1,"status":"pending","rescheduleCount":0}},"11-20":{"preacher":{"memberId":1,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":2,"status":"pending","rescheduleCount":0}},"11-27":{"preacher":{"memberId":12,"status":"pending","rescheduleCount":0},"facilitator":{"memberId":4,"status":"pending","rescheduleCount":0}}}; // __BAKE_POINT__

        const MONTH_NAMES = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const DAY_NAMES = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        let currentView = 'month';

        // Monthly devotional themes and Bible verses
        const MONTHLY_THEMES = [
            { theme: "New Beginnings", verse: "Behold, I am doing a new thing; now it springs forth, do you not perceive it?", ref: "Isaiah 43:19" },
            { theme: "Love & Unity", verse: "Above all, clothe yourselves with love, which binds us all together in perfect harmony.", ref: "Colossians 3:14" },
            { theme: "Faith & Endurance", verse: "Let us run with endurance the race that is set before us, looking unto Jesus.", ref: "Hebrews 12:1-2" },
            { theme: "Resurrection Power", verse: "I want to know Christ and the power of His resurrection and the fellowship of sharing in His sufferings.", ref: "Philippians 3:10" },
            { theme: "Growth & Fruitfulness", verse: "But the fruit of the Spirit is love, joy, peace, forbearance, kindness, goodness, faithfulness.", ref: "Galatians 5:22" },
            { theme: "Prayer & Intercession", verse: "The earnest prayer of a righteous person has great power and produces wonderful results.", ref: "James 5:16" },
            { theme: "God's Faithfulness", verse: "Great is Thy faithfulness, O God my Father; morning by morning new mercies I see.", ref: "Lamentations 3:23" },
            { theme: "Strength & Courage", verse: "Be strong and courageous. Do not be afraid; do not be discouraged, for the Lord your God will be with you.", ref: "Joshua 1:9" },
            { theme: "Wisdom & Understanding", verse: "If any of you lacks wisdom, let him ask God, who gives generously to all without reproach.", ref: "James 1:5" },
            { theme: "Harvest & Thanksgiving", verse: "Let us not become weary in doing good, for at the proper time we will reap a harvest if we do not give up.", ref: "Galatians 6:9" },
            { theme: "Hope & Restoration", verse: "For I know the plans I have for you, declares the Lord, plans to prosper you and not to harm you.", ref: "Jeremiah 29:11" },
            { theme: "Joy & Celebration", verse: "For unto us a Child is born, unto us a Son is given, and the government shall be upon His shoulder.", ref: "Isaiah 9:6" }
        ];

        // ============================================================
        //  RENDER CALENDAR
        // ============================================================
        function renderCalendar() {
            const grid = document.getElementById('calGrid');
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const today = new Date();

            // Adjust first day (Mon=0 format)
            const startOffset = firstDay === 0 ? 6 : firstDay - 1;

            let html = '';
            // Empty cells before month starts
            for (let i = 0; i < startOffset; i++) {
                html += '<div class="cal-cell empty"></div>';
            }

            for (let d = 1; d <= daysInMonth; d++) {
                const date = new Date(currentYear, currentMonth, d);
                const isSunday = date.getDay() === 0;
                const isToday = date.toDateString() === today.toDateString();
                const isPast = date < new Date(today.getFullYear(), today.getMonth(), today.getDate());

                const dayEvents = getEventsForDate(currentMonth, d);
                const filteredEvents = filterEvents(dayEvents);

                let classes = 'cal-cell';
                if (isSunday) classes += ' sunday';
                if (isToday) classes += ' today';
                if (isPast) classes += ' past';

                let dots = '';
                if (filteredEvents.length > 0) {
                    dots = '<div class="event-dots">';
                    const deptsSeen = new Set();
                    filteredEvents.forEach(ev => {
                        const allDepts = ev.depts || [ev.dept];
                        allDepts.forEach(d => {
                            const deptClass = d === 'prayer' ? 'dot-prayer' : `dot-${d}`;
                            if (!deptsSeen.has(deptClass)) {
                                dots += `<span class="event-dot ${deptClass}"></span>`;
                                deptsSeen.add(deptClass);
                            }
                        });
                    });
                    dots += '</div>';
                }

                html += `<div class="${classes}" onclick="openDayModal(${currentMonth}, ${d})">
            <span class="day-num">${d}</span>
            ${dots}
        </div>`;
            }

            grid.innerHTML = html;
            document.getElementById('monthYear').textContent = `${MONTH_NAMES[currentMonth]} ${currentYear}`;
            renderMonthVerse();
            renderEventList();
        }

        function renderMonthVerse() {
            const container = document.getElementById('monthVerse');
            const t = MONTHLY_THEMES[currentMonth];
            container.innerHTML = `
        <div class="theme-label">${t.theme}</div>
        <div class="verse-text">"${t.verse}"</div>
        <div class="verse-ref">‚Äî ${t.ref}</div>
    `;
        }

        function getEventsForDate(month, day) {
            return EVENTS.filter(ev => {
                if (ev.month !== month) return false;
                if (ev.endDay && ev.endDay !== ev.day) {
                    return day >= ev.day && day <= ev.endDay;
                }
                return ev.day === day;
            });
        }

        function filterEvents(events) {
            if (activeFilter === 'all') return events;
            return events.filter(ev => {
                // Check if this event belongs to the active filter department
                if (ev.depts && ev.depts.includes(activeFilter)) return true;
                if (ev.dept === activeFilter) return true;
                return false;
            });
        }

        function renderEventList() {
            const container = document.getElementById('monthEvents');
            const monthEvents = EVENTS.filter(ev => ev.month === currentMonth);
            const filtered = filterEvents(monthEvents);

            // Sort by day
            filtered.sort((a, b) => a.day - b.day);

            // Remove duplicate prayer entries for cleaner display, group them
            const displayed = [];
            const prayerDays = [];
            filtered.forEach(ev => {
                if (ev.title === "Prayer and Fasting" && !ev.title.includes("10 Days")) {
                    prayerDays.push(ev.day);
                } else {
                    displayed.push(ev);
                }
            });

            let html = `<h3>${MONTH_NAMES[currentMonth]} ${currentYear} ‚Äî Events</h3>`;

            if (prayerDays.length > 0 && (activeFilter === 'all' || activeFilter === 'prayer')) {
                html += `<div class="event-item" onclick="showActivityInfo('Prayer and Fasting')">
            <div class="event-date-badge bg-prayer">MON</div>
            <div class="event-info">
                <div class="event-title">Prayer & Fasting (Every Monday)</div>
                <div class="event-dept">Weekly ¬∑ Dates: ${prayerDays.join(', ')}</div>
            </div>
            <div class="info-icon" title="What is this?">?</div>
        </div>`;
            }

            displayed.forEach(ev => {
                const bgClass = ev.dept === 'prayer' ? 'bg-prayer' : `bg-${ev.dept}`;
                const dateLabel = ev.endDay && ev.endDay !== ev.day ? `${ev.day}-${ev.endDay}` : ev.day;
                const dow = new Date(currentYear, ev.month, ev.day).getDay();
                const isSunday = dow === 0;

                // Check for Sunday assignment
                let serviceHtml = '';
                if (isSunday && ev.title !== "Prayer and Fasting") {
                    const aKey = `${ev.month}-${ev.day}`;
                    const assign = assignments[aKey];
                    if (assign) {
                        const preacher = MEMBERS.find(m => m.id === assign.preacher.memberId);
                        const facilitator = MEMBERS.find(m => m.id === assign.facilitator.memberId);
                        serviceHtml = `<div class="event-service">
                    üé§ ${facilitator ? facilitator.name : 'TBA'} ¬∑ üìñ ${preacher ? preacher.name : 'TBA'}
                </div>`;
                    }
                }

                const allDepts2 = ev.depts || [ev.dept];
                const deptLabel = allDepts2.map(d => d === 'sunday-school' ? 'Sunday School' : (d === 'prayer' ? 'Prayer' : d.charAt(0).toUpperCase() + d.slice(1))).join(' & ');

                html += `<div class="event-item" onclick="openDayModal(${ev.month}, ${ev.day})">
            <div class="event-date-badge ${bgClass}">${dateLabel}</div>
            <div class="event-info">
                <div class="event-title">${ev.title}</div>
                <div class="event-dept">${DAY_NAMES[dow]} ¬∑ ${deptLabel}</div>
                ${serviceHtml}
            </div>
            ${ACTIVITY_INFO[ev.title] || ACTIVITY_INFO[ev.title.replace(/ \(.*\)/, '')] ? '<div class="info-icon" onclick="event.stopPropagation();showActivityInfo(\'' + ev.title.replace(/'/g, "\\'") + '\')">?</div>' : ''}
        </div>`;
            });

            if (displayed.length === 0 && prayerDays.length === 0) {
                html += '<p style="text-align:center;color:#aaa;font-size:0.8rem;padding:20px;">No events for this filter.</p>';
            }

            container.innerHTML = html;
        }

        // ============================================================
        //  NAVIGATION & FILTERS
        // ============================================================
        function changeMonth(dir) {
            currentMonth += dir;
            if (currentMonth < 0) currentMonth = 0;
            if (currentMonth > 11) currentMonth = 11;
            if (currentView === 'month') {
                renderCalendar();
            } else {
                renderMultiMonth();
            }
        }

        // ============================================================
        //  VIEW MODE SWITCHING
        // ============================================================
        function setView(view) {
            currentView = view;
            document.querySelectorAll('.view-tab').forEach(t => t.classList.toggle('active', t.dataset.view === view));

            const single = document.getElementById('singleMonthContainer');
            const multi = document.getElementById('multiMonthContainer');
            const verse = document.getElementById('monthVerse');
            const nav = document.querySelector('.nav');
            const filters = document.querySelector('.filters');

            if (view === 'month') {
                single.style.display = '';
                multi.style.display = 'none';
                verse.style.display = '';
                nav.style.display = '';
                filters.style.display = '';
                renderCalendar();
            } else {
                single.style.display = 'none';
                multi.style.display = 'block';
                verse.style.display = 'none';
                nav.style.display = 'none';
                filters.style.display = '';  // Keep filters visible in all views
                renderMultiMonth();
            }
        }

        function renderMultiMonth() {
            const container = document.getElementById('multiMonthContainer');
            let months = [];

            if (currentView === 'quarter') {
                // Current quarter (3 months)
                const qStart = Math.floor(currentMonth / 3) * 3;
                months = [qStart, qStart + 1, qStart + 2];
            } else if (currentView === 'half') {
                const hStart = currentMonth < 6 ? 0 : 6;
                months = [hStart, hStart + 1, hStart + 2, hStart + 3, hStart + 4, hStart + 5];
            } else {
                months = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11];
            }

            let html = `<div class="multi-month-grid ${currentView}">`;
            const today = new Date();

            months.forEach(m => {
                const daysInMonth = new Date(currentYear, m + 1, 0).getDate();
                const firstDay = new Date(currentYear, m, 1).getDay();
                const startOffset = firstDay === 0 ? 6 : firstDay - 1;
                const t = MONTHLY_THEMES[m];
                const monthEventsAll = EVENTS.filter(ev => ev.month === m && ev.title !== 'Prayer and Fasting');
                const monthEvents = filterEvents(monthEventsAll);

                html += `<div class="mini-month" onclick="currentMonth=${m};setView('month');">`;
                html += `<h4>${MONTH_NAMES[m]}</h4>`;
                html += `<div style="text-align:center;font-style:italic;font-size:0.55rem;color:#999;margin-bottom:6px;font-family:Georgia,serif;">"${t.verse.substring(0, 60)}..." ‚Äî ${t.ref}</div>`;
                html += '<div class="mini-cal-grid">';
                html += '<span class="mini-hdr">M</span><span class="mini-hdr">T</span><span class="mini-hdr">W</span><span class="mini-hdr">T</span><span class="mini-hdr">F</span><span class="mini-hdr">S</span><span class="mini-hdr" style="color:#c62828">S</span>';

                for (let i = 0; i < startOffset; i++) html += '<span class="mini-empty"></span>';

                for (let d = 1; d <= daysInMonth; d++) {
                    const dt = new Date(currentYear, m, d);
                    const isSun = dt.getDay() === 0;
                    const isToday = dt.toDateString() === today.toDateString();
                    const hasEvent = monthEvents.some(ev => d >= ev.day && d <= (ev.endDay || ev.day));
                    let cls = 'mini-day';
                    if (isSun) cls += ' mini-sunday';
                    if (isToday) cls += ' mini-today';
                    if (hasEvent) cls += ' mini-has-event';
                    html += `<span class="${cls}">${d}</span>`;
                }
                html += '</div>';

                // Key events summary (filtered)
                const keyEvents = monthEvents.slice(0, 5);
                if (keyEvents.length > 0) {
                    html += '<div class="mini-events">';
                    keyEvents.forEach(ev => {
                        const dateLabel = ev.endDay && ev.endDay !== ev.day ? `${ev.day}-${ev.endDay}` : ev.day;
                        html += `<div class="mini-ev">üìå ${dateLabel}: ${ev.title}</div>`;
                    });
                    html += '</div>';
                }
                html += '</div>';
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function setFilter(dept) {
            activeFilter = dept;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.dept === dept);
            });
            if (currentView === 'month') {
                renderCalendar();
            } else {
                renderMultiMonth();
            }
        }

        // ============================================================
        //  MODAL: Day Details
        // ============================================================
        function openDayModal(month, day) {
            const date = new Date(currentYear, month, day);
            const dayEvents = getEventsForDate(month, day);
            const isSunday = date.getDay() === 0;
            const aKey = `${month}-${day}`;

            let html = '<div class="modal-handle"></div>';
            html += `<h2>${DAY_NAMES[date.getDay()]}, ${day} ${MONTH_NAMES[month]} ${currentYear}</h2>`;

            // Sunday Service Details
            if (isSunday) {
                const assign = assignments[aKey];
                const specialDept = getSpecialSundayDept(month, day);

                if (specialDept) {
                    const deptLabel = specialDept === 'sunday-school' ? 'Sunday School' : specialDept.charAt(0).toUpperCase() + specialDept.slice(1);
                    html += `<div style="background:linear-gradient(135deg,#FF9800,#F57C00);color:#fff;padding:10px 14px;border-radius:10px;margin-bottom:12px;text-align:center;font-weight:700;font-size:0.95rem;">
                        üè∑Ô∏è ${deptLabel} Department-Led Service
                    </div>`;
                }

                html += '<div class="section-label">Sunday Service ‚Äî 10:00 AM</div>';

                if (assign) {
                    const preacher = MEMBERS.find(m => m.id === assign.preacher.memberId);
                    const facilitator = MEMBERS.find(m => m.id === assign.facilitator.memberId);

                    html += `<div class="detail-card">
                <div class="label">Facilitator / Chairperson</div>
                <div class="value">${facilitator ? facilitator.name : 'TBA'} 
                    <span class="status-badge status-${assign.facilitator.status}">${assign.facilitator.status.toUpperCase()}</span>
                </div>
            </div>`;

                    html += `<div class="detail-card">
                <div class="label">Preacher</div>
                <div class="value">${preacher ? preacher.name : 'TBA'} 
                    <span class="status-badge status-${assign.preacher.status}">${assign.preacher.status.toUpperCase()}</span>
                </div>
            </div>`;

                    // Confirmation actions
                    html += buildConfirmationUI(aKey, assign, month, day);
                }
            }

            // Events for this day
            if (dayEvents.length > 0) {
                html += '<div class="section-label">Events</div>';
                dayEvents.forEach(ev => {
                    const infoText = ACTIVITY_INFO[ev.title] || ACTIVITY_INFO[ev.title.replace(/ \(.*\)/, '')] || '';
                    const deptColor = ev.dept === 'prayer' ? '#78909C' : (ev.dept === 'general' ? '#e94560' : (ev.dept === 'ladies' ? '#E91E63' : (ev.dept === 'men' ? '#1565C0' : (ev.dept === 'youth' ? '#FF9800' : (ev.dept === 'sunday-school' ? '#4CAF50' : '#7B1FA2')))));

                    // Build department label showing all departments
                    const allDepts = ev.depts || [ev.dept];
                    const deptLabel = allDepts.map(d => d === 'sunday-school' ? 'Sunday School' : (d === 'prayer' ? 'Prayer' : d.charAt(0).toUpperCase() + d.slice(1))).join(' & ');

                    html += `<div class="detail-card" style="border-left: 3px solid ${deptColor};">
                <div class="value">${ev.title}</div>
                <div class="label">${deptLabel} Department</div>
                ${ev.endDay && ev.endDay !== ev.day ? `<div class="label" style="margin-top:4px;">üìÖ ${ev.day} ‚Äî ${ev.endDay} ${MONTH_NAMES[month]}</div>` : ''}
            </div>`;

                    if (infoText) {
                        html += `<div class="description-box">‚ÑπÔ∏è ${infoText}</div>`;
                    }
                });
            }

            // WhatsApp share for this day
            if (isSunday || dayEvents.length > 0) {
                const shareText = buildDayShareText(month, day, dayEvents, isSunday);
                const waUrl = `https://wa.me/?text=${encodeURIComponent(shareText)}`;
                html += `<div style="margin-top:16px;display:flex;gap:8px;flex-wrap:wrap;">
            <a href="${waUrl}" target="_blank" class="btn btn-whatsapp" style="text-decoration:none;">üì± Share on WhatsApp</a>
            <button class="btn btn-close" onclick="closeModal()">Close</button>
        </div>`;
            } else {
                html += `<div style="margin-top:16px;">
            <button class="btn btn-close" onclick="closeModal()">Close</button>
        </div>`;
            }

            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('modalOverlay').classList.add('active');
        }

        // ============================================================
        //  CONFIRMATION WORKFLOW UI
        // ============================================================
        function buildConfirmationUI(aKey, assign, month, day) {
            let html = '<div class="confirm-section">';

            // ‚îÄ‚îÄ ACCESS CONTROL ‚îÄ‚îÄ
            // Only Secretary / Pastor (logged in) can manage confirmations.
            // Church members see read-only status badges.
            const canManage = isAdminLoggedIn; // secretary or pastor

            html += `<div class="section-label">${canManage ? 'Availability Management' : 'Assignment Status'}</div>`;

            ['facilitator', 'preacher'].forEach(role => {
                const data = assign[role];
                const member = MEMBERS.find(m => m.id === data.memberId);
                const roleLabel = role === 'facilitator' ? 'üé§ Facilitator' : 'üìñ Preacher';

                if (data.status === 'confirmed' || data.status === 'locked') {
                    html += `<div class="detail-card" style="border-left:3px solid #4CAF50;">
                <div class="label">${roleLabel}: ${member ? member.name : 'TBA'}</div>
                <div class="value" style="color:#2E7D32;">‚úÖ Confirmed & Locked</div>
            </div>`;
                } else if (data.status === 'declined') {
                    html += `<div class="detail-card" style="border-left:3px solid #f44336;">
                <div class="label">${roleLabel}: ${member ? member.name : 'TBA'}</div>
                <div class="value" style="color:#C62828;">‚ùå Declined</div>
                ${canManage ? `<div style="margin-top:8px;">
                    <button class="btn btn-edit" onclick="showAlternatives('${aKey}','${role}',${month},${day})">Find Alternative</button>
                </div>` : ''}
            </div>`;
                } else {
                    // Pending
                    html += `<div class="detail-card">
                <div class="label">${roleLabel}: ${member ? member.name : 'TBA'}</div>
                <div class="value" style="color:#FF9800;">‚è≥ Pending</div>`;

                    if (canManage) {
                        html += `<div class="reschedule-count">Reschedule attempts: ${data.rescheduleCount} / 2</div>
                <div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:4px;">
                    <button class="btn btn-confirm" onclick="confirmAssignment('${aKey}','${role}')">‚úÖ Confirm</button>
                    ${data.rescheduleCount < 2 ?
                                `<button class="btn btn-reschedule" onclick="rescheduleAssignment('${aKey}','${role}',${month},${day})">üîÑ Reschedule</button>` : ''}
                    <button class="btn btn-decline" onclick="declineAssignment('${aKey}','${role}',${month},${day})">‚ùå Decline</button>
                    <button class="btn btn-whatsapp" onclick="sendConfirmationRequest('${aKey}','${role}',${month},${day})">üì± Ask via WhatsApp</button>
                </div>`;
                    }

                    html += `</div>`;
                }
            });

            if (!canManage) {
                html += `<div class="description-box" style="margin-top:8px;font-size:0.7rem;color:#888;">üîí Only the Secretary or Pastor can manage confirmations. Log in via ‚öô to access controls.</div>`;
            }

            html += '</div>';
            return html;
        }

        // ============================================================
        //  CONFIRMATION ACTIONS
        // ============================================================
        function confirmAssignment(aKey, role) {
            if (!isAdminLoggedIn) { showToast('üîí Admin login required'); return; }
            assignments[aKey][role].status = 'confirmed';
            saveAssignments();

            const member = MEMBERS.find(m => m.id === assignments[aKey][role].memberId);
            showToast(`‚úÖ ${member.name} confirmed as ${role}!`);

            // Notify Pastor and Secretary via WhatsApp
            const [month, day] = aKey.split('-').map(Number);
            const dateStr = `${day} ${MONTH_NAMES[month]} ${currentYear}`;
            const msg = `‚úÖ CONFIRMATION: ${member.name} has confirmed as ${role} for Sunday ${dateStr} at AFM Galway Assembly.`;

            setTimeout(() => {
                if (confirm(`Notify Pastor & Secretary via WhatsApp?\n\n${msg}`)) {
                    window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
                }
            }, 500);

            openDayModal(month, day);
        }

        function rescheduleAssignment(aKey, role, month, day) {
            if (!isAdminLoggedIn) { showToast('üîí Admin login required'); return; }
            const data = assignments[aKey][role];
            if (data.rescheduleCount >= 2) {
                showToast('‚ùå Maximum reschedules reached. Can only decline.');
                return;
            }

            // Show available Sundays for rescheduling
            const sundays = getAllSundays(currentYear).filter(s => {
                const sKey = `${s.month}-${s.day}`;
                const sDate = new Date(currentYear, s.month, s.day);
                return sDate > new Date() && sKey !== aKey;
            });

            let options = sundays.slice(0, 12).map(s =>
                `${s.day} ${MONTH_NAMES[s.month]} ${currentYear}`
            ).join('\n');

            const newDate = prompt(`Current: ${day} ${MONTH_NAMES[month]} ${currentYear}\n\nPropose a new Sunday (enter day month, e.g. "15 March"):\n\nAvailable Sundays:\n${options}`);

            if (!newDate) return;

            data.rescheduleCount++;

            // Parse proposed date and try to swap
            const parts = newDate.trim().split(/\s+/);
            if (parts.length >= 2) {
                const newDay = parseInt(parts[0]);
                const newMonthIdx = MONTH_NAMES.findIndex(m => m.toLowerCase().startsWith(parts[1].toLowerCase()));

                if (newMonthIdx >= 0 && newDay > 0) {
                    const newKey = `${newMonthIdx}-${newDay}`;
                    if (assignments[newKey]) {
                        // Swap the member to the new date
                        const memberId = data.memberId;
                        const otherMemberId = assignments[newKey][role].memberId;

                        assignments[newKey][role].memberId = memberId;
                        assignments[newKey][role].status = 'pending';
                        data.memberId = otherMemberId;
                        data.status = 'pending';

                        saveAssignments();
                        showToast(`üîÑ Rescheduled! ${MEMBERS.find(m => m.id === memberId).name} moved to ${newDay} ${MONTH_NAMES[newMonthIdx]}`);

                        // Notify
                        const member = MEMBERS.find(m => m.id === memberId);
                        const msg = `üîÑ RESCHEDULE: ${member.name} (${role}) rescheduled from ${day} ${MONTH_NAMES[month]} to ${newDay} ${MONTH_NAMES[newMonthIdx]} ${currentYear}. (Attempt ${data.rescheduleCount}/2)`;
                        setTimeout(() => {
                            if (confirm(`Notify via WhatsApp?\n\n${msg}`)) {
                                window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
                            }
                        }, 500);

                        openDayModal(month, day);
                        return;
                    }
                }
            }

            showToast('‚ö†Ô∏è Could not process reschedule. Please try again.');
            openDayModal(month, day);
        }

        function declineAssignment(aKey, role, month, day) {
            if (!isAdminLoggedIn) { showToast('üîí Admin login required'); return; }
            const member = MEMBERS.find(m => m.id === assignments[aKey][role].memberId);
            if (confirm(`${member.name} declines ${role} for ${day} ${MONTH_NAMES[month]}?`)) {
                assignments[aKey][role].status = 'declined';
                saveAssignments();
                showToast(`‚ùå ${member.name} declined. Please find an alternative.`);
                openDayModal(month, day);
            }
        }

        function showAlternatives(aKey, role, month, day) {
            if (!isAdminLoggedIn) { showToast('üîí Admin login required'); return; }
            const isPreach = role === 'preacher';
            const currentId = assignments[aKey][role].memberId;
            const specialDept = getSpecialSundayDept(month, day);

            // Count current allocations for deficit sorting
            const counts = computeAllocationCounts();

            // Get eligible alternatives
            let alternatives;
            if (specialDept) {
                alternatives = getDeptMembers(specialDept, role).filter(m => {
                    if (m.id === currentId) return false;
                    if (m.id === 4 && !isPanayoteAvailable(month)) return false;
                    const otherRole = role === 'preacher' ? 'facilitator' : 'preacher';
                    if (assignments[aKey][otherRole].memberId === m.id) return false;
                    return true;
                });
            } else {
                alternatives = MEMBERS.filter(m => {
                    if (m.id === currentId) return false;
                    if (isPreach && !m.canPreach) return false;
                    if (!isPreach && !m.canFacilitate) return false;
                    if (m.id === 4 && !isPanayoteAvailable(month)) return false;
                    const otherRole = role === 'preacher' ? 'facilitator' : 'preacher';
                    if (assignments[aKey][otherRole].memberId === m.id) return false;
                    return true;
                });
            }

            // Sort by deficit: least-served members first (best alternatives)
            const roleKey = isPreach ? 'preach' : 'facilitate';
            alternatives.sort((a, b) => {
                const ca = (counts[a.id] || {})[roleKey] || 0;
                const cb = (counts[b.id] || {})[roleKey] || 0;
                return ca - cb;
            });

            // Always include Pastor in alternatives for non-Special Sundays
            if (!specialDept && !alternatives.find(m => m.id === 1)) {
                const pastor = MEMBERS.find(m => m.id === 1);
                const otherRole = role === 'preacher' ? 'facilitator' : 'preacher';
                if (pastor && currentId !== 1 && assignments[aKey][otherRole].memberId !== 1) {
                    alternatives.push(pastor);
                }
            }

            let html = '<div class="modal-handle"></div>';
            html += `<h2>Find Alternative ${role === 'preacher' ? 'Preacher' : 'Facilitator'}</h2>`;
            html += `<div class="modal-date">${day} ${MONTH_NAMES[month]} ${currentYear}</div>`;
            if (specialDept) {
                const deptLabel = specialDept === 'sunday-school' ? 'Sunday School' : specialDept.charAt(0).toUpperCase() + specialDept.slice(1);
                html += `<div class="section-label" style="color:#FF9800;">üè∑Ô∏è ${deptLabel} Special Sunday ‚Äî Department Members Only</div>`;
            } else {
                html += '<div class="section-label">Available Members <small style="color:#888;">(sorted by least assigned)</small></div>';
            }
            html += '<div class="alternative-list">';

            alternatives.forEach(m => {
                const mc = counts[m.id] || {};
                const cnt = mc[roleKey] || 0;
                const badge = `<small style="background:#f0f0f0;padding:2px 6px;border-radius:8px;margin-left:6px;">${roleKey === 'preach' ? 'üìñ' : 'üé§'} ${cnt}√ó</small>`;
                html += `<div class="alt-member">
            <span>${m.name} <small style="color:#888">(${m.role})</small>${badge}</span>
            <button onclick="assignAlternative('${aKey}','${role}',${m.id},${month},${day})">Assign</button>
        </div>`;
            });

            html += '</div>';
            html += `<div style="margin-top:16px;">
        <button class="btn btn-close" onclick="openDayModal(${month},${day})">‚Üê Back</button>
    </div>`;

            document.getElementById('modalContent').innerHTML = html;
        }

        function assignAlternative(aKey, role, memberId, month, day) {
            if (!isAdminLoggedIn) { showToast('üîí Admin login required'); return; }
            assignments[aKey][role].memberId = memberId;
            assignments[aKey][role].status = 'pending';
            assignments[aKey][role].rescheduleCount = 0;
            saveAssignments();

            const member = MEMBERS.find(m => m.id === memberId);
            showToast(`‚úÖ ${member.name} assigned as ${role}. Awaiting confirmation.`);

            // Offer to send WhatsApp
            const dateStr = `${day} ${MONTH_NAMES[month]} ${currentYear}`;
            const msg = `üôè Dear ${member.name}, you have been assigned as ${role.toUpperCase()} for the Sunday Service on ${dateStr} at AFM Galway Assembly (10:00 AM). Please confirm your availability. Reply CONFIRM, RESCHEDULE, or DECLINE. Thank you!`;

            setTimeout(() => {
                if (confirm(`Send assignment request to ${member.name} via WhatsApp?`)) {
                    window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
                }
            }, 500);

            openDayModal(month, day);
        }

        function getSecretaryPhone() {
            return localStorage.getItem('secretary_phone') || '353871081856';
        }

        function getPastorPhone() {
            return localStorage.getItem('pastor_phone') || '353899407593';
        }

        function isDelegatedToPastor() {
            return localStorage.getItem('delegated_to_pastor') === 'true';
        }

        function getActivePhone() {
            if (isDelegatedToPastor()) {
                const pp = getPastorPhone();
                if (pp) return pp;
            }
            return getSecretaryPhone();
        }

        function toggleDelegation() {
            const current = isDelegatedToPastor();
            if (!current) {
                const pp = getPastorPhone();
                if (!pp) {
                    alert('Pastor phone number not set.\nGo to \u2699 Settings first and add it.');
                    setupGitHub();
                    return;
                }
                localStorage.setItem('delegated_to_pastor', 'true');
                showToast('\ud83d\udce1 Duties delegated to Pastor. WhatsApp replies will go to Pastor.');
            } else {
                localStorage.setItem('delegated_to_pastor', 'false');
                showToast('\u2705 Delegation revoked. WhatsApp replies will come to you.');
            }
            updateDelegationUI();
        }

        function updateDelegationUI() {
            const btn = document.getElementById('delegateBtn');
            if (!btn) return;
            if (isDelegatedToPastor()) {
                btn.textContent = '\ud83d\udd19 Revoke Pastor Delegation';
                btn.className = 'btn btn-decline';
                btn.style.cssText = 'width:100%;margin:6px 0;';
            } else {
                btn.textContent = '\ud83d\udce1 Delegate Duties to Pastor';
                btn.className = 'btn btn-edit';
                btn.style.cssText = 'width:100%;margin:6px 0;';
            }
        }

        function sendConfirmationRequest(aKey, role, month, day) {
            if (!isAdminLoggedIn) { showToast('üîí Admin login required'); return; }
            const member = MEMBERS.find(m => m.id === assignments[aKey][role].memberId);
            const dateStr = `${day} ${MONTH_NAMES[month]}`;
            const roleLabel = role === 'facilitator' ? 'Facilitator' : 'Preacher';
            const roleShort = role === 'facilitator' ? 'FAC' : 'PRE';
            const phone = getActivePhone();

            if (!phone) {
                alert('Please set your WhatsApp phone number first.\nGo to ‚öô Secretary Panel ‚Üí ‚öô Settings ‚Üí enter your number.');
                setupGitHub();
                return;
            }

            // Short reply texts
            const confirmReply = encodeURIComponent(`‚úÖ CONFIRM ${roleShort} ${dateStr}`);
            const rescheduleReply = encodeURIComponent(`üîÑ RESCHEDULE ${roleShort} ${dateStr}`);
            const declineReply = encodeURIComponent(`‚ùå DECLINE ${roleShort} ${dateStr}`);

            const confirmLink = `https://wa.me/${phone}?text=${confirmReply}`;
            const rescheduleLink = `https://wa.me/${phone}?text=${rescheduleReply}`;
            const declineLink = `https://wa.me/${phone}?text=${declineReply}`;

            const signer = isDelegatedToPastor() ? 'Pastor C Mudada' : 'Secretary';
            const specialDept = getSpecialSundayDept(month, day);
            const deptNote = specialDept ? (() => {
                const dl = specialDept === 'sunday-school' ? 'Sunday School' : specialDept.charAt(0).toUpperCase() + specialDept.slice(1);
                return `\nüè∑Ô∏è *${dl} Dept-Led Service*\n`;
            })() : '';

            const msg = `‚úùÔ∏è *AFM Galway*\n\nüôè Dear ${member.name},\n\nYou are *${roleLabel}* on *Sun ${dateStr}* (10AM).${deptNote}\n\nTap to reply:\n\n‚úÖ CONFIRM: ${confirmLink}\nüîÑ RESCHEDULE: ${rescheduleLink}\n‚ùå DECLINE: ${declineLink}\n\n‚Äî ${signer}`;

            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        }

        // ============================================================
        //  ALLOCATION MATRIX & ANALYTICS
        // ============================================================
        function computeAllocationCounts() {
            const counts = {};
            MEMBERS.forEach(m => { counts[m.id] = { preach: 0, facilitate: 0, total: 0 }; });
            const sundays = getAllSundays(currentYear);
            sundays.forEach(s => {
                const key = `${s.month}-${s.day}`;
                const a = assignments[key];
                if (!a) return;
                if (a.preacher && counts[a.preacher.memberId]) {
                    counts[a.preacher.memberId].preach++;
                    counts[a.preacher.memberId].total++;
                }
                if (a.facilitator && counts[a.facilitator.memberId]) {
                    counts[a.facilitator.memberId].facilitate++;
                    counts[a.facilitator.memberId].total++;
                }
            });
            return counts;
        }

        function computeTargets() {
            const sundays = getAllSundays(currentYear);
            const normalCount = sundays.filter(s => !getSpecialSundayDept(s.month, s.day)).length;
            const pPool = MEMBERS.filter(m => getPreacherWeight(m) > 0);
            const fPool = MEMBERS.filter(m => getFacilitatorWeight(m) > 0);
            const totalPW = pPool.reduce((s, m) => s + getPreacherWeight(m), 0);
            const totalFW = fPool.reduce((s, m) => s + getFacilitatorWeight(m), 0);
            const targets = {};
            MEMBERS.forEach(m => {
                const pw = getPreacherWeight(m);
                const fw = getFacilitatorWeight(m);
                targets[m.id] = {
                    preach: pw > 0 ? Math.max(1, Math.round(normalCount * pw / totalPW)) : 0,
                    facilitate: fw > 0 ? Math.max(1, Math.round(normalCount * fw / totalFW)) : 0
                };
            });
            return targets;
        }

        function showAllocationMatrix() {
            const counts = computeAllocationCounts();
            const targets = computeTargets();

            let html = '<div class="modal-handle"></div>';
            html += `<h2>üìä Allocation Matrix ${currentYear}</h2>`;
            html += '<div class="modal-date">Year-end duty distribution across all members</div>';

            // Summary stats
            const sundays = getAllSundays(currentYear);
            const normalCount = sundays.filter(s => !getSpecialSundayDept(s.month, s.day)).length;
            const specialCount = sundays.length - normalCount;
            html += `<div class="description-box" style="margin:10px 0;font-size:0.7rem;">üìÖ Total Sundays: <strong>${sundays.length}</strong> &nbsp;‚îÇ&nbsp; Normal: <strong>${normalCount}</strong> &nbsp;‚îÇ&nbsp; Special: <strong>${specialCount}</strong></div>`;

            // Preacher table
            html += '<div class="section-label">üìñ Preaching Rota</div>';
            html += '<div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;font-size:0.7rem;margin:6px 0;">';
            html += '<tr style="background:#f5f5f5;"><th style="text-align:left;padding:6px;">Member</th><th style="padding:6px;">Tier</th><th style="padding:6px;">Actual</th><th style="padding:6px;">Target</th><th style="padding:6px;">Balance</th></tr>';

            const preachMembers = MEMBERS.filter(m => m.canPreach && getPreacherWeight(m) > 0)
                .sort((a, b) => (counts[b.id].preach || 0) - (counts[a.id].preach || 0));
            preachMembers.forEach(m => {
                const c = counts[m.id].preach;
                const t = targets[m.id].preach;
                const diff = c - t;
                const bar = buildBar(c, t);
                const color = diff > 1 ? '#f44336' : (diff < -1 ? '#FF9800' : '#4CAF50');
                const diffStr = diff > 0 ? `+${diff}` : `${diff}`;
                const tier = getMemberTier(m);
                const tierLabel = tier === 'adult' ? 'üë§' : (tier === 'young-adult' ? 'üßë' : 'üë¶');
                html += `<tr style="border-bottom:1px solid #eee;">
                    <td style="padding:6px;">${tierLabel} ${m.name}</td>
                    <td style="padding:6px;text-align:center;font-size:0.6rem;color:#888;">${tier}</td>
                    <td style="padding:6px;text-align:center;font-weight:700;">${c}</td>
                    <td style="padding:6px;text-align:center;color:#888;">${t}</td>
                    <td style="padding:6px;text-align:center;"><span style="color:${color};font-weight:600;">${diffStr}</span> ${bar}</td>
                </tr>`;
            });
            html += '</table></div>';

            // Facilitator table
            html += '<div class="section-label">üé§ Facilitation Rota</div>';
            html += '<div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;font-size:0.7rem;margin:6px 0;">';
            html += '<tr style="background:#f5f5f5;"><th style="text-align:left;padding:6px;">Member</th><th style="padding:6px;">Tier</th><th style="padding:6px;">Actual</th><th style="padding:6px;">Target</th><th style="padding:6px;">Balance</th></tr>';

            const facMembers = MEMBERS.filter(m => m.canFacilitate && getFacilitatorWeight(m) > 0)
                .sort((a, b) => (counts[b.id].facilitate || 0) - (counts[a.id].facilitate || 0));
            facMembers.forEach(m => {
                const c = counts[m.id].facilitate;
                const t = targets[m.id].facilitate;
                const diff = c - t;
                const bar = buildBar(c, t);
                const color = diff > 1 ? '#f44336' : (diff < -1 ? '#FF9800' : '#4CAF50');
                const diffStr = diff > 0 ? `+${diff}` : `${diff}`;
                const tier = getMemberTier(m);
                const tierLabel = tier === 'adult' ? 'üë§' : (tier === 'young-adult' ? 'üßë' : 'üë¶');
                html += `<tr style="border-bottom:1px solid #eee;">
                    <td style="padding:6px;">${tierLabel} ${m.name}</td>
                    <td style="padding:6px;text-align:center;font-size:0.6rem;color:#888;">${tier}</td>
                    <td style="padding:6px;text-align:center;font-weight:700;">${c}</td>
                    <td style="padding:6px;text-align:center;color:#888;">${t}</td>
                    <td style="padding:6px;text-align:center;"><span style="color:${color};font-weight:600;">${diffStr}</span> ${bar}</td>
                </tr>`;
            });
            html += '</table></div>';

            // Monthly breakdown for Pastor
            html += '<div class="section-label">üìÖ Pastor Monthly Preaching</div>';
            html += '<div style="display:flex;flex-wrap:wrap;gap:4px;margin:6px 0;">';
            for (let mo = 0; mo < 12; mo++) {
                let moCount = 0;
                const moSundays = getAllSundays(currentYear).filter(s => s.month === mo);
                moSundays.forEach(s => {
                    const a = assignments[`${s.month}-${s.day}`];
                    if (a && a.preacher.memberId === 1) moCount++;
                });
                const bg = moCount > 2 ? '#FF9800' : (moCount === 0 ? '#eee' : '#4CAF50');
                const fg = moCount === 0 ? '#999' : '#fff';
                html += `<div style="background:${bg};color:${fg};padding:4px 8px;border-radius:6px;font-size:0.65rem;min-width:55px;text-align:center;">
                    <div style="font-weight:600;">${MONTH_NAMES[mo].slice(0, 3)}</div><div style="font-size:0.8rem;">${moCount}</div>
                </div>`;
            }
            html += '</div>';

            html += `<div style="margin-top:16px;display:flex;gap:8px;">
                <button class="btn btn-close" onclick="closeModal()">Close</button>
            </div>`;

            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('modalOverlay').classList.add('active');
        }

        function buildBar(actual, target) {
            if (target === 0) return '';
            const pct = Math.min(150, Math.round((actual / target) * 100));
            const w = Math.min(60, Math.round(pct * 0.4));
            const c = pct > 120 ? '#f44336' : (pct < 80 ? '#FF9800' : '#4CAF50');
            return `<div style="display:inline-block;width:60px;height:6px;background:#eee;border-radius:3px;vertical-align:middle;margin-left:4px;">
                <div style="width:${w}px;height:6px;background:${c};border-radius:3px;"></div></div>`;
        }

        // ============================================================
        //  DATA PERSISTENCE
        // ============================================================
        function saveAssignments() {
            localStorage.setItem('afm_assignments', JSON.stringify(assignments));
            renderCalendar();
        }

        function exportData() {
            const data = JSON.stringify(assignments, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `AFM_Galway_${currentYear}_CalendarData.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('üíæ Data exported!');
        }

        // ============================================================
        //  GITHUB AUTO-PUBLISH
        // ============================================================
        const GH_DEFAULTS = { owner: 'tuls78', repo: 'eCalGalway', file: 'index.html' };

        function getGHConfig() {
            return {
                token: localStorage.getItem('gh_token') || '',
                owner: localStorage.getItem('gh_owner') || GH_DEFAULTS.owner,
                repo: localStorage.getItem('gh_repo') || GH_DEFAULTS.repo,
                file: localStorage.getItem('gh_file') || GH_DEFAULTS.file
            };
        }

        function setupGitHub() {
            const cfg = getGHConfig();
            const phone = getSecretaryPhone();
            const pastorPhone = getPastorPhone();
            let html = '<div class="modal-handle"></div>';
            html += '<h2>‚öô App Settings</h2>';
            html += '<div class="modal-date">One-time setup</div>';

            // WhatsApp Section
            html += '<div class="section-label">WhatsApp Confirmation Links</div>';
            html += '<div class="description-box" style="margin:8px 0;">'
                + 'üì± Enter numbers with country code, no spaces or dashes.<br>'
                + 'Example: <strong>353871234567</strong> (Ireland = 353)</div>';
            html += `<label style="font-size:0.75rem;font-weight:600;">Secretary WhatsApp Number:</label>`;
            html += `<input type="tel" id="secPhone" value="${phone}" placeholder="353871081856" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;margin:4px 0 10px;font-size:0.8rem;">`;
            html += `<label style="font-size:0.75rem;font-weight:600;">Pastor WhatsApp Number:</label>`;
            html += `<input type="tel" id="pastorPhone" value="${pastorPhone}" placeholder="353871234567" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;margin:4px 0 14px;font-size:0.8rem;">`;

            // GitHub Section
            html += '<div class="section-label">GitHub Auto-Publish</div>';
            html += '<div class="description-box" style="margin:8px 0;">'
                + 'üìå <strong>How to get a Token:</strong><br>'
                + '1. Go to <a href="https://github.com/settings/tokens" target="_blank" style="color:#007bff;">github.com/settings/tokens</a><br>'
                + '2. Click <strong>"Generate new token (classic)"</strong><br>'
                + '3. Give it a name (e.g. "AFM Calendar")<br>'
                + '4. Check the <strong>"repo"</strong> scope<br>'
                + '5. Click "Generate token" and copy it</div>';
            html += `<label style="font-size:0.75rem;font-weight:600;">Personal Access Token:</label>`;
            html += `<input type="password" id="ghToken" value="${cfg.token}" placeholder="ghp_xxxxxxxxxxxx" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;margin:4px 0 10px;font-size:0.8rem;">`;
            html += `<label style="font-size:0.75rem;font-weight:600;">Repository Owner:</label>`;
            html += `<input type="text" id="ghOwner" value="${cfg.owner}" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;margin:4px 0 10px;font-size:0.8rem;">`;
            html += `<label style="font-size:0.75rem;font-weight:600;">Repository Name:</label>`;
            html += `<input type="text" id="ghRepo" value="${cfg.repo}" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;margin:4px 0 10px;font-size:0.8rem;">`;
            html += `<div style="margin-top:12px;display:flex;gap:8px;">`;
            html += `<button class="btn btn-confirm" onclick="saveGHSettings()">üíæ Save All Settings</button>`;
            html += `<button class="btn btn-close" onclick="closeModal()">Cancel</button>`;
            html += `</div>`;

            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('modalOverlay').classList.add('active');
        }

        function saveGHSettings() {
            const phone = document.getElementById('secPhone').value.trim().replace(/[^0-9]/g, '');
            const pastorPhone = document.getElementById('pastorPhone').value.trim().replace(/[^0-9]/g, '');
            const token = document.getElementById('ghToken').value.trim();
            const owner = document.getElementById('ghOwner').value.trim();
            const repo = document.getElementById('ghRepo').value.trim();

            // Save phones
            if (phone) localStorage.setItem('secretary_phone', phone);
            if (pastorPhone) localStorage.setItem('pastor_phone', pastorPhone);

            // Save GitHub (if provided)
            if (token) {
                localStorage.setItem('gh_token', token);
                localStorage.setItem('gh_owner', owner || GH_DEFAULTS.owner);
                localStorage.setItem('gh_repo', repo || GH_DEFAULTS.repo);
            }

            closeModal();
            showToast('‚úÖ Settings saved!');
        }

        // Reset assignments only ‚Äî now only removes the specific key
        function resetAssignmentsOnly() {
            if (!confirm('Are you sure you want to reset ALL assignments and confirmations?\n\nThis cannot be undone.')) return;

            localStorage.removeItem('afm_assignments');
            showToast('‚ôªÔ∏è Assignments reset successfully. Reloading...');
            setTimeout(() => location.reload(), 1500);
        }

        async function buildPublishableHTML() {
            // Fetch the ORIGINAL clean source ‚Äî avoids DOM serialisation issues
            let htmlContent;
            try {
                const resp = await fetch(window.location.href);
                if (resp.ok) htmlContent = await resp.text();
            } catch (e) { /* file:// CORS ‚Äì fall through */ }

            // Fallback: DOM serialisation (strip runtime state)
            if (!htmlContent) {
                htmlContent = '<!DOCTYPE html>\n' + document.documentElement.outerHTML;
                // Remove any 'active' class on admin panel so it starts closed
                htmlContent = htmlContent.replace(/class="admin-panel"/g, 'class="admin-panel"');
            }

            // Bake current assignment data into the source
            const dataString = JSON.stringify(assignments);
            const baked = `let assignments = ${dataString}; // __BAKE_POINT__`;

            // Match either the original source line or a previously baked version
            const marker = /let\s+assignments\s*=\s*.+?\/\/\s*__BAKE_POINT__/;
            if (marker.test(htmlContent)) {
                htmlContent = htmlContent.replace(marker, baked);
            } else {
                // Legacy fallback ‚Äî match generateInitialAssignments()
                htmlContent = htmlContent.replace(
                    'let assignments = generateInitialAssignments();',
                    baked
                );
            }

            // On the published page, skip localStorage and use baked data directly
            // Override generateInitialAssignments so it simply returns what we baked
            const funcOverride = 'function generateInitialAssignments() {\n' +
                '            const saved = localStorage.getItem(\'afm_assignments\');\n' +
                '            if (saved) return JSON.parse(saved);';
            const funcReplacement = 'function generateInitialAssignments() {\n' +
                '            return assignments; // Published ‚Äî use baked data\n' +
                '            const saved = localStorage.getItem(\'afm_assignments\');\n' +
                '            if (saved) return JSON.parse(saved);';
            if (htmlContent.includes(funcOverride) && !htmlContent.includes('return assignments; // Published')) {
                htmlContent = htmlContent.replace(funcOverride, funcReplacement);
            }

            return htmlContent;
        }

        // Base64 encode that handles Unicode
        function utf8ToBase64(str) {
            const bytes = new TextEncoder().encode(str);
            let binary = '';
            bytes.forEach(b => binary += String.fromCharCode(b));
            return btoa(binary);
        }

        async function publishToGitHub() {
            const cfg = getGHConfig();
            if (!cfg.token) {
                alert('GitHub token not set. Click "‚öô GitHub Settings" first.');
                setupGitHub();
                return;
            }

            const btn = document.getElementById('publishBtn');
            btn.textContent = '‚è≥ Publishing...';
            btn.disabled = true;

            try {
                const apiBase = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${cfg.file}`;
                const headers = {
                    'Authorization': `token ${cfg.token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                };

                // Step 1: Get the current file SHA (needed for updates)
                let sha = '';
                try {
                    const getRes = await fetch(apiBase, { headers });
                    if (getRes.ok) {
                        const fileData = await getRes.json();
                        sha = fileData.sha;
                    }
                } catch (e) { /* File may not exist yet, that's OK */ }

                // Step 2: Build the publishable HTML with baked-in data
                const htmlContent = await buildPublishableHTML();
                const contentBase64 = utf8ToBase64(htmlContent);

                // Step 3: Push to GitHub
                const now = new Date();
                const timestamp = now.toLocaleDateString('en-IE') + ' ' + now.toLocaleTimeString('en-IE', { hour: '2-digit', minute: '2-digit' });
                const body = {
                    message: `üìÖ Calendar updated ‚Äî ${timestamp}`,
                    content: contentBase64
                };
                if (sha) body.sha = sha; // Include SHA for updates

                const putRes = await fetch(apiBase, {
                    method: 'PUT',
                    headers,
                    body: JSON.stringify(body)
                });

                if (putRes.ok) {
                    showToast('‚úÖ Published to GitHub!');
                    alert(`‚úÖ Live site updated!\n\nYour calendar is now live at:\nhttps://${cfg.owner}.github.io/${cfg.repo}/\n\nIt may take ~60 seconds for changes to appear.`);
                } else {
                    const err = await putRes.json();
                    throw new Error(err.message || 'Unknown error');
                }

            } catch (error) {
                console.error('GitHub publish error:', error);
                alert('‚ùå Publish failed: ' + error.message + '\n\nCheck your token and repository settings.');
            } finally {
                btn.textContent = 'üöÄ Publish to GitHub';
                btn.disabled = false;
            }
        }

        function importDataPrompt() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        assignments = JSON.parse(ev.target.result);
                        saveAssignments();
                        showToast('üìÇ Data restored!');
                        renderCalendar();
                    } catch (err) {
                        showToast('‚ùå Invalid file format');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // ============================================================
        //  ADMIN: Show All Pending
        // ============================================================
        function showAllPendingModal() {
            let html = '<div class="modal-handle"></div>';
            html += '<h2>All Pending Confirmations</h2>';
            html += '<div class="modal-date">Assignments awaiting response</div>';

            const sundays = getAllSundays(currentYear);
            let hasPending = false;

            sundays.forEach(s => {
                const key = `${s.month}-${s.day}`;
                const assign = assignments[key];
                if (!assign) return;

                const pending = [];
                if (assign.preacher.status === 'pending' || assign.preacher.status === 'declined') {
                    const m = MEMBERS.find(mem => mem.id === assign.preacher.memberId);
                    pending.push({ role: 'Preacher', member: m, status: assign.preacher.status });
                }
                if (assign.facilitator.status === 'pending' || assign.facilitator.status === 'declined') {
                    const m = MEMBERS.find(mem => mem.id === assign.facilitator.memberId);
                    pending.push({ role: 'Facilitator', member: m, status: assign.facilitator.status });
                }

                if (pending.length > 0) {
                    hasPending = true;
                    html += `<div class="detail-card" style="cursor:pointer;" onclick="closeModal();currentMonth=${s.month};renderCalendar();setTimeout(()=>openDayModal(${s.month},${s.day}),300);">
                <div class="value">${s.day} ${MONTH_NAMES[s.month]} ${currentYear}</div>`;
                    pending.forEach(p => {
                        html += `<div class="label">${p.role}: ${p.member ? p.member.name : 'TBA'} 
                    <span class="status-badge status-${p.status}">${p.status.toUpperCase()}</span>
                </div>`;
                    });
                    html += '</div>';
                }
            });

            if (!hasPending) {
                html += '<p style="text-align:center;padding:30px;color:#888;">üéâ All confirmations are up to date!</p>';
            }

            html += `<div style="margin-top:16px;">
        <button class="btn btn-close" onclick="closeModal()">Close</button>
    </div>`;

            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('modalOverlay').classList.add('active');
        }

        // ============================================================
        //  ACTIVITY INFO POPUP
        // ============================================================
        function showActivityInfo(title) {
            const cleanTitle = title.replace(/ \(.*\)/, '');
            const info = ACTIVITY_INFO[title] || ACTIVITY_INFO[cleanTitle] || 'No additional information available for this activity.';

            let html = '<div class="modal-handle"></div>';
            html += `<h2>${title}</h2>`;
            html += `<div class="description-box" style="margin-top:12px;">‚ÑπÔ∏è ${info}</div>`;
            html += `<div style="margin-top:16px;">
        <button class="btn btn-close" onclick="closeModal()">Close</button>
    </div>`;

            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('modalOverlay').classList.add('active');
        }

        // ============================================================
        //  WHATSAPP SHARING
        // ============================================================
        function buildDayShareText(month, day, events, isSunday) {
            let text = `‚úùÔ∏è *AFM IRELAND ‚Äî GALWAY ASSEMBLY*\n`;
            text += `üìÖ *${DAY_NAMES[new Date(currentYear, month, day).getDay()]}, ${day} ${MONTH_NAMES[month]} ${currentYear}*\n\n`;

            if (isSunday) {
                const specialDept = getSpecialSundayDept(month, day);
                if (specialDept) {
                    const deptLabel = specialDept === 'sunday-school' ? 'Sunday School' : specialDept.charAt(0).toUpperCase() + specialDept.slice(1);
                    text += `üè∑Ô∏è *${deptLabel} Department-Led Service*\n`;
                }
                text += `‚õ™ *Sunday Service ‚Äî 10:00 AM*\n`;
                text += `üìç Galway Westside Community Hall, H91 R853\n\n`;

                const aKey = `${month}-${day}`;
                const assign = assignments[aKey];
                if (assign) {
                    const facilitator = MEMBERS.find(m => m.id === assign.facilitator.memberId);
                    const preacher = MEMBERS.find(m => m.id === assign.preacher.memberId);
                    text += `üé§ Facilitator: *${facilitator ? facilitator.name : 'TBA'}*\n`;
                    text += `üìñ Preacher: *${preacher ? preacher.name : 'TBA'}*\n\n`;
                }
            }

            events.forEach(ev => {
                if (ev.title !== "Prayer and Fasting") {
                    text += `üìå ${ev.title}\n`;
                }
            });

            text += `\nüôè _Worship With Us!_`;
            return text;
        }

        function shareMonthCalendar() {
            let text = `‚úùÔ∏è *AFM IRELAND ‚Äî GALWAY ASSEMBLY*\n`;
            text += `üìÖ *${MONTH_NAMES[currentMonth]} ${currentYear} ‚Äî Calendar*\n\n`;
            text += `‚õ™ Every Sunday ¬∑ 10:00 AM\n`;
            text += `üìç Galway Westside Community Hall\n\n`;

            const monthEvents = EVENTS.filter(ev => ev.month === currentMonth && ev.title !== "Prayer and Fasting");
            monthEvents.sort((a, b) => a.day - b.day);

            const sundays = getAllSundays(currentYear).filter(s => s.month === currentMonth);

            sundays.forEach(s => {
                const aKey = `${s.month}-${s.day}`;
                const assign = assignments[aKey];
                const dayEvents = monthEvents.filter(ev => ev.day === s.day);
                const dateStr = `${s.day} ${MONTH_NAMES[s.month]}`;
                const specialDept = getSpecialSundayDept(s.month, s.day);

                text += `*üìÖ Sunday ${dateStr}*\n`;
                if (specialDept) {
                    const deptLabel = specialDept === 'sunday-school' ? 'Sunday School' : specialDept.charAt(0).toUpperCase() + specialDept.slice(1);
                    text += `  üè∑Ô∏è *${deptLabel} Department-Led Service*\n`;
                }
                if (assign) {
                    const f = MEMBERS.find(m => m.id === assign.facilitator.memberId);
                    const p = MEMBERS.find(m => m.id === assign.preacher.memberId);
                    text += `  üé§ ${f ? f.name : 'TBA'}\n`;
                    text += `  üìñ ${p ? p.name : 'TBA'}\n`;
                }
                dayEvents.forEach(ev => {
                    text += `  üìå ${ev.title}\n`;
                });
                text += '\n';
            });

            // Non-Sunday events
            const nonSundayEvents = monthEvents.filter(ev => new Date(currentYear, ev.month, ev.day).getDay() !== 0);
            if (nonSundayEvents.length > 0) {
                text += `*Other Events:*\n`;
                nonSundayEvents.forEach(ev => {
                    const dow = DAY_NAMES[new Date(currentYear, ev.month, ev.day).getDay()];
                    const dateRange = ev.endDay && ev.endDay !== ev.day ? `${ev.day}-${ev.endDay}` : ev.day;
                    text += `  üìå ${dateRange} ${MONTH_NAMES[ev.month]} (${dow}) ‚Äî ${ev.title}\n`;
                });
                text += '\n';
            }

            text += `üôè _Prayer & Fasting every Monday_\n`;
            text += `üôè _Worship With Us!_`;

            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        }

        // ============================================================
        //  MODAL HELPERS
        // ============================================================
        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
        }

        function closeModalOutside(event) {
            if (event.target === document.getElementById('modalOverlay')) {
                closeModal();
            }
        }

        let isAdminLoggedIn = false;
        let adminRole = ''; // 'pastor' or 'secretary'

        function toggleAdmin() {
            const p = document.getElementById('adminPanel');
            if (p.classList.contains('active')) {
                p.classList.remove('active');
                return;
            }

            // If already logged in this session, just open
            if (isAdminLoggedIn) {
                p.classList.add('active');
                return;
            }

            // Prompt for password
            const pass = prompt("Enter Access Password (Pastor or Secretary):");
            if (!pass) return;

            // NOTE: Client-side simple authentication. Not for high-security data.
            // Password Logic
            if (pass === "Shepherd26") {
                isAdminLoggedIn = true;
                adminRole = 'pastor';
                showToast("üîì Welcome, Pastor Mudada!");
                p.classList.add('active');
                checkYearEndReminder();
            }
            else if (pass === "Galway26") {
                isAdminLoggedIn = true;
                adminRole = 'secretary';
                showToast("üîì Welcome, Secretary!");
                p.classList.add('active');
                checkYearEndReminder();
            }
            else {
                alert("‚ùå Incorrect Password. Access Denied.");
            }
        }

        // ============================================================
        //  TOAST (Queue-based)
        // ============================================================
        let toastQueue = [];
        let isToastVisible = false;

        function showToast(msg) {
            toastQueue.push(msg);
            processToastQueue();
        }

        function processToastQueue() {
            if (isToastVisible || toastQueue.length === 0) return;

            const msg = toastQueue.shift();
            const toast = document.getElementById('toast');

            isToastVisible = true;
            toast.textContent = msg;
            toast.classList.add('active');

            // Show for 3s, then hide
            setTimeout(() => {
                toast.classList.remove('active');
                // Wait for transition (300ms) then check queue
                setTimeout(() => {
                    isToastVisible = false;
                    processToastQueue();
                }, 300);
            }, 3000);
        }

        // ============================================================
        //  IN-APP HELP ‚Äî Role-Based Guide
        // ============================================================
        function showHelp() {
            // ‚îÄ‚îÄ Determine which help sections this user can see ‚îÄ‚îÄ
            // Not logged in  ‚Üí member only (public calendar viewer)
            // Pastor login   ‚Üí member + responder + pastor
            // Secretary login ‚Üí everything (full admin)
            const sections = [];
            sections.push({ id: 'member', label: 'üë• Member', btn: 'btn-confirm' });

            if (isAdminLoggedIn) {
                sections.push({ id: 'responder', label: 'üì± WhatsApp', btn: 'btn-edit' });
                if (adminRole === 'pastor') {
                    sections.push({ id: 'pastor', label: '‚õ™ Pastor', btn: 'btn-reschedule' });
                }
                if (adminRole === 'secretary') {
                    sections.push({ id: 'responder_skip', label: '', btn: '' }); // already added
                    sections.push({ id: 'secretary', label: 'üìã Secretary', btn: 'btn-whatsapp' });
                    sections.push({ id: 'pastor', label: '‚õ™ Pastor', btn: 'btn-reschedule' });
                }
            }

            // De-duplicate (responder already added for both roles)
            const seen = new Set();
            const unique = sections.filter(s => {
                if (!s.label || seen.has(s.id)) return false;
                seen.add(s.id);
                return true;
            });

            let html = '<div class="modal-handle"></div>';
            html += '<h2>‚ùì Help & Guide</h2>';

            if (!isAdminLoggedIn) {
                html += '<div class="modal-date">Church Member Guide</div>';
            } else if (adminRole === 'pastor') {
                html += '<div class="modal-date">Pastor Help ‚Äî tap a section</div>';
            } else {
                html += '<div class="modal-date">Secretary Help ‚Äî tap a section</div>';
            }

            if (unique.length > 1) {
                html += `<div style="display:flex;flex-wrap:wrap;gap:6px;margin:12px 0;">`;
                unique.forEach(s => {
                    html += `<button class="btn ${s.btn}" onclick="showHelpSection('${s.id}')" style="flex:1;min-width:100px;">${s.label}</button>`;
                });
                html += `</div>`;
            }

            html += '<div id="helpContent"></div>';
            html += `<div style="margin-top:16px;"><button class="btn btn-close" onclick="closeModal()">Close</button></div>`;

            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('modalOverlay').classList.add('active');
            showHelpSection(unique[0].id);
        }

        function showHelpSection(role) {
            const el = document.getElementById('helpContent');
            let h = '';

            if (role === 'member') {
                h += `<div class="section-label">üë• Church Member Guide</div>`;
                h += `<div class="description-box" style="margin:6px 0;">
                    <strong>Welcome to the AFM Galway ${currentYear} E-Calendar!</strong><br><br>
                    This calendar shows all church events, Sunday service assignments, and departmental activities for the year.
                </div>`;
                h += `<div class="detail-card">
                    <div class="label">üìÖ Viewing the Calendar</div>
                    <div class="value" style="font-size:0.75rem;line-height:1.5;">‚Ä¢ Use <strong>‚óÄ ‚ñ∂</strong> arrows to move between months<br>
                    ‚Ä¢ Tap any <strong>date</strong> to see events and Sunday assignments<br>
                    ‚Ä¢ Switch between <strong>Monthly, Quarterly, Half-Year, or Full Year</strong> views using the tabs at the top</div>
                </div>`;
                h += `<div class="detail-card">
                    <div class="label">üè∑Ô∏è Department Filters</div>
                    <div class="value" style="font-size:0.75rem;line-height:1.5;">Tap a department button (Ladies, Men, Youth, etc.) to see <strong>only that department's events</strong>. Filters work in all views. Tap <strong>All</strong> to see everything again.</div>
                </div>`;
                h += `<div class="detail-card">
                    <div class="label">üì± Sharing</div>
                    <div class="value" style="font-size:0.75rem;line-height:1.5;">Tap the <strong>üì±</strong> button at the bottom-right to share the current month's calendar and rota on WhatsApp.</div>
                </div>`;
                h += `<div class="detail-card">
                    <div class="label">üè∑Ô∏è Special Sundays</div>
                    <div class="value" style="font-size:0.75rem;line-height:1.5;">Some Sundays are <strong>Department-Led Services</strong> ‚Äî the designated department runs the entire service (worship, facilitation, preaching). These are marked with an orange banner when you tap that date.</div>
                </div>`;
            }

            if (role === 'responder') {
                h += `<div class="section-label">üì± WhatsApp Availability ‚Äî How to Respond</div>`;
                h += `<div class="description-box" style="margin:6px 0;">
                    When you are assigned a duty (Preacher or Facilitator), the Secretary will send you a WhatsApp message with <strong>three clickable links</strong>.
                </div>`;
                h += `<div class="detail-card" style="border-left:3px solid #4CAF50;">
                    <div class="label">‚úÖ CONFIRM</div>
                    <div class="value" style="font-size:0.75rem;line-height:1.5;">Tap this link if you <strong>will be available</strong> on the assigned date. A pre-filled WhatsApp message will open ‚Äî just send it. Your status will be marked as confirmed.</div>
                </div>`;
                h += `<div class="detail-card" style="border-left:3px solid #FF9800;">
                    <div class="label">üîÑ RESCHEDULE</div>
                    <div class="value" style="font-size:0.75rem;line-height:1.5;">Tap this if you'd like to <strong>propose a different date</strong>. You can reschedule up to <strong>2 times</strong>. The Secretary will find someone to swap with you.</div>
                </div>`;
                h += `<div class="detail-card" style="border-left:3px solid #f44336;">
                    <div class="label">‚ùå DECLINE</div>
                    <div class="value" style="font-size:0.75rem;line-height:1.5;">Tap this if you are <strong>unable to attend</strong>. The Secretary will assign an alternative member. No hard feelings ‚Äî just let us know early!</div>
                </div>`;
                h += `<div class="detail-card">
                    <div class="label">üí° Tips</div>
                    <div class="value" style="font-size:0.75rem;line-height:1.5;">‚Ä¢ Respond as soon as possible so alternatives can be arranged<br>
                    ‚Ä¢ You only need to tap one link ‚Äî it opens WhatsApp with a ready-made reply<br>
                    ‚Ä¢ If the Secretary is away, replies go to the Pastor instead</div>
                </div>`;
            }

            if (role === 'secretary') {
                h += `<div class="section-label">üìã Secretary Guide</div>`;
                h += `<div class="description-box" style="margin:6px 0;">
                    Access the <strong>Secretary Panel</strong> by tapping <strong>‚öô</strong> and entering the Secretary password.
                </div>`;
                h += `<div class="detail-card">
                    <div class="label">üìå Core Duties</div>
                    <div class="value" style="font-size:0.75rem;line-height:1.5;">‚Ä¢ <strong>View All Pending</strong> ‚Äî See all assignments not yet confirmed<br>
                    ‚Ä¢ <strong>Tap a Sunday</strong> ‚Üí use ‚úÖ Confirm / üîÑ Reschedule / ‚ùå Decline / üì± WhatsApp buttons<br>
                    ‚Ä¢ <strong>Find Alternative</strong> ‚Äî When someone declines, pick a replacement (sorted by least-assigned first)</div>
                </div>`;
                h += `<div class="detail-card">
                    <div class="label">üöÄ Publishing</div>
                    <div class="value" style="font-size:0.75rem;line-height:1.5;">‚Ä¢ Click <strong>üöÄ Publish to GitHub</strong> to push the latest rota to the live website<br>
                    ‚Ä¢ Your GitHub token is saved and reused ‚Äî enter it once in ‚öô Settings<br>
                    ‚Ä¢ Always publish after making changes so the public site is up to date</div>
                </div>`;
                h += `<div class="detail-card">
                    <div class="label">üìä Allocation Matrix</div>
                    <div class="value" style="font-size:0.75rem;line-height:1.5;">‚Ä¢ Shows <strong>actual vs target</strong> duties for every member<br>
                    ‚Ä¢ Green = balanced, Orange = underserved, Red = overserved<br>
                    ‚Ä¢ Use this to make fair manual adjustments</div>
                </div>`;
                h += `<div class="detail-card">
                    <div class="label">üì° Delegation</div>
                    <div class="value" style="font-size:0.75rem;line-height:1.5;">‚Ä¢ When you're unavailable, tap <strong>üì° Delegate Duties to Pastor</strong><br>
                    ‚Ä¢ WhatsApp availability replies will then go to the Pastor's number<br>
                    ‚Ä¢ Tap again to reclaim duties when you return</div>
                </div>`;
                h += `<div class="detail-card">
                    <div class="label">üíæ Backup & Restore</div>
                    <div class="value" style="font-size:0.75rem;line-height:1.5;">‚Ä¢ <strong>Export Data</strong> saves a JSON backup of all assignments<br>
                    ‚Ä¢ <strong>Import Data</strong> restores from a backup file<br>
                    ‚Ä¢ <strong>Reset All Data</strong> clears assignments but keeps your token & phone numbers</div>
                </div>`;
            }

            if (role === 'pastor') {
                h += `<div class="section-label">‚õ™ Pastor Guide</div>`;
                h += `<div class="description-box" style="margin:6px 0;">
                    Access the admin panel by tapping <strong>‚öô</strong> and entering the Pastor password.
                </div>`;
                h += `<div class="detail-card">
                    <div class="label">üìñ Your Preaching Schedule</div>
                    <div class="value" style="font-size:0.75rem;line-height:1.5;">‚Ä¢ You are assigned to preach approximately <strong>2 Sundays per month</strong> (max 3)<br>
                    ‚Ä¢ The system avoids scheduling you on consecutive Sundays<br>
                    ‚Ä¢ You are always listed as an <strong>alternative</strong> on Sundays you're not preaching<br>
                    ‚Ä¢ Check the <strong>üìä Allocation Matrix</strong> ‚Üí Pastor Monthly Preaching section for your schedule</div>
                </div>`;
                h += `<div class="detail-card">
                    <div class="label">üì° Delegation</div>
                    <div class="value" style="font-size:0.75rem;line-height:1.5;">‚Ä¢ When the Secretary delegates duties to you, <strong>WhatsApp availability replies come to your phone</strong><br>
                    ‚Ä¢ You can then confirm, reschedule, or decline on behalf of members<br>
                    ‚Ä¢ All admin features are available to you while delegated</div>
                </div>`;
                h += `<div class="detail-card">
                    <div class="label">üè∑Ô∏è Special Sundays</div>
                    <div class="value" style="font-size:0.75rem;line-height:1.5;">‚Ä¢ Department-Led Sundays are run entirely by that department<br>
                    ‚Ä¢ <strong>Ladies:</strong> Mrs Pastor L Mudada leads preaching<br>
                    ‚Ä¢ <strong>Youth:</strong> Mr V Gill (Youth Leader) leads preaching<br>
                    ‚Ä¢ <strong>Sunday School:</strong> Mrs S Gill preaches, children may facilitate<br>
                    ‚Ä¢ <strong>Men's:</strong> Mr Dube, Mr T Ncube, Mr V Gill rotate</div>
                </div>`;
                h += `<div class="detail-card">
                    <div class="label">‚ö†Ô∏è Important Notes</div>
                    <div class="value" style="font-size:0.75rem;line-height:1.5;">‚Ä¢ National events (conferences, camps) don't cancel local Sunday services<br>
                    ‚Ä¢ Most members cannot travel to national events ‚Äî normal rota continues<br>
                    ‚Ä¢ The live website auto-updates when the Secretary publishes</div>
                </div>`;
            }

            el.innerHTML = h;
        }

        // ============================================================
        //  EDIT ASSIGNMENT (inline from admin)
        // ============================================================
        function editAssignmentRole(aKey, role, month, day) {
            if (!isAdminLoggedIn) { showToast('üîí Admin login required'); return; }
            const isPreach = role === 'preacher';
            const eligible = MEMBERS.filter(m => {
                if (isPreach && !m.canPreach) return false;
                if (!isPreach && !m.canFacilitate) return false;
                if (m.id === 4 && !isPanayoteAvailable(month)) return false;
                return true;
            });

            const current = assignments[aKey][role].memberId;
            const names = eligible.map(m => `${m.id}: ${m.name}`).join('\n');
            const input = prompt(`Select new ${role} (enter number):\n\n${names}`);

            if (input) {
                const newId = parseInt(input);
                const member = MEMBERS.find(m => m.id === newId);
                if (member) {
                    assignments[aKey][role].memberId = newId;
                    assignments[aKey][role].status = 'pending';
                    assignments[aKey][role].rescheduleCount = 0;
                    saveAssignments();
                    showToast(`Updated ${role} to ${member.name}`);
                    openDayModal(month, day);
                }
            }
        }

        // ============================================================
        //  INITIALIZE
        // ============================================================
        function init() {
            const now = new Date();
            // If we're in the calendar's year, go to the current month
            if (now.getFullYear() === currentYear) {
                currentMonth = now.getMonth();
            } else {
                currentMonth = 0;
            }

            // Dynamic subtitle
            const sub = document.getElementById('yearSubtitle');
            if (sub) sub.textContent = `${currentYear} Church E-Calendar`;

            // Dynamic page title
            document.title = `AFM Galway Assembly ‚Äì ${currentYear} E-Calendar`;

            renderCalendar();
            updateDelegationUI();
        }

        function checkYearEndReminder() {
            // Only for Secretary or Pastor
            if (!isAdminLoggedIn) return;

            const now = new Date();
            const thisYear = now.getFullYear();
            const nextYear = thisYear + 1;

            // Only show from 15 November onwards when viewing the current year's calendar
            if (now.getMonth() < 10 || (now.getMonth() === 10 && now.getDate() < 15)) return;
            if (currentYear !== thisYear) return;

            // Only show once per session
            if (window.__yearEndReminderShown) return;
            window.__yearEndReminderShown = true;

            // Show reminder after a short delay so it doesn't block page load
            setTimeout(() => {
                const dismissKey = `year_reminder_${nextYear}_dismissed`;
                if (localStorage.getItem(dismissKey) === 'true') return;

                let html = '<div class="modal-handle"></div>';
                html += `<h2>üìÖ Prepare ${nextYear} Calendar</h2>`;
                html += `<div class="description-box" style="margin:10px 0;">
                    <strong>‚è∞ It's time to plan ahead!</strong><br><br>
                    The ${thisYear} church calendar is nearing its end. Please prepare the <strong>${nextYear} E-Calendar</strong> with updated events, assignments, and any new members.
                </div>`;
                html += `<div class="detail-card">
                    <div class="label">üìã Steps for Next Year</div>
                    <div class="value" style="font-size:0.75rem;line-height:1.6;">
                        1. Update the <strong>events list</strong> in the code for ${nextYear} (dates, conferences, camps)<br>
                        2. Review and update the <strong>MEMBERS</strong> array (new members, departed members, age updates)<br>
                        3. Update <strong>Special Sunday</strong> dates for ${nextYear}<br>
                        4. <strong>Reset All Data</strong> to clear ${thisYear} assignments<br>
                        5. The system will auto-generate new balanced assignments for ${nextYear}<br>
                        6. <strong>Publish</strong> the updated calendar to the live website
                    </div>
                </div>`;
                html += `<div class="detail-card" style="border-left:3px solid #FF9800;">
                    <div class="label">‚ö†Ô∏è Important</div>
                    <div class="value" style="font-size:0.75rem;">Export a backup of ${thisYear} data before resetting. Your GitHub token and phone numbers will be preserved.</div>
                </div>`;
                html += `<div style="margin-top:16px;display:flex;gap:8px;flex-wrap:wrap;">
                    <button class="btn btn-confirm" onclick="localStorage.setItem('${dismissKey}','true');closeModal();showToast('Reminder dismissed until next year');">Got it ‚Äî Dismiss</button>
                    <button class="btn btn-close" onclick="closeModal()">Remind Me Later</button>
                </div>`;

                document.getElementById('modalContent').innerHTML = html;
                document.getElementById('modalOverlay').classList.add('active');
            }, 2000);
        }

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') changeMonth(-1);
            if (e.key === 'ArrowRight') changeMonth(1);
            if (e.key === 'Escape') {
                closeModal();
                document.getElementById('adminPanel').classList.remove('active');
            }
        });

        // Close admin panel when clicking outside
        document.addEventListener('click', (e) => {
            const panel = document.getElementById('adminPanel');
            const toggleBtn = document.querySelector('.admin-toggle');
            if (panel.classList.contains('active') && !panel.contains(e.target) && e.target !== toggleBtn) {
                panel.classList.remove('active');
            }
        });

        // Touch swipe for month navigation
        let touchStartX = 0;
        document.addEventListener('touchstart', (e) => { touchStartX = e.touches[0].clientX; });
        document.addEventListener('touchend', (e) => {
            const diff = touchStartX - e.changedTouches[0].clientX;
            if (Math.abs(diff) > 80) {
                changeMonth(diff > 0 ? 1 : -1);
            }
        });

        init();
    </script>


</body></html>